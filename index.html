<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트 학급 관리 플랫폼</title>
    <link rel="icon" type="image/png" href="/portal-dev/favicon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* [공통 스타일] */
        :root {
            --primary-color: #5D78E6; --secondary-color: #A25AF2; --light-bg: #f4f6fc;
            --white-bg: #ffffff; --text-dark: #212529; --text-light: #6c757d;
            --border-color: #e9ecef; --border-radius: 12px; --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--light-bg); min-height: 100vh; padding: 20px; color: var(--text-dark); }
        .container { max-width: 800px; margin: 0 auto; background: var(--white-bg); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 40px 30px; text-align: center; }
        .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 10px; }
        .header .date-display { font-size: 1.2em; opacity: 0.9; }
        .content { padding: 30px; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-light); font-size: 1.1em; }
        .section { margin-bottom: 30px; }
        .section-title { font-size: 1.4em; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .card { background: var(--white-bg); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .card-title { font-size: 1.1em; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); }
        .card-description { font-size: 0.95em; color: var(--text-light); line-height: 1.6; }
        a.card { text-decoration: none; color: inherit; display: block; transition: transform 0.2s; }
        a.card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .action-btn { padding: 8px 16px; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500; text-decoration: none; display: inline-block; margin-top: 12px; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; }
        .tab-button { padding: 12px 18px; cursor: pointer; border: none; background: none; font-size: 1em; font-weight: 500; color: var(--text-light); position: relative; }
        .tab-button.active { color: var(--primary-color); font-weight: 600; }
        .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--primary-color); border-radius: 3px; }
        .tab-pane { display: none; } .tab-pane.active { display: block; }
        .user-display { display: flex; align-items: center; gap: 12px; }
        .user-profile-image { width: 36px; height: 36px; border-radius: 50%; }
        .user-initial { width: 36px; height: 36px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .user-name-logout { font-size: 0.9em; text-align: left; }
        .user-name-logout strong { display: block; }
        .user-name-logout a { text-decoration: none; }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .student-header { padding: 0 30px; background-color: #fff; min-height: 60px; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid var(--border-color); }
        .student-header .user-name-logout { color: var(--text-dark); }
        .student-header .user-name-logout a { color: var(--text-light); }
        #widgets-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .widget { background-color: var(--white-bg); padding: 20px; text-align: center; border-radius: var(--border-radius); box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .widget-title { font-weight: 500; margin-bottom: 8px; color: var(--text-light); }
        .widget-content { font-size: 2.2em; font-weight: 700; color: var(--primary-color); }
        .unsubmitted-section { background-color: #fff9e6; border: 1px solid #ffe7ab; color: #8a6d3b; padding: 15px 20px; margin-bottom: 30px; border-radius: var(--border-radius); }
        .notice-item { display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary-color); }
        .complete-btn { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 14px; border-radius: 20px; cursor: pointer; font-size: 0.9em; flex-shrink: 0; margin-left: 15px; }
        .leave-form { background: #f8f9fa; padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
        .leave-type-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .leave-type-btn { background-color: #e9ecef; color: #495057; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
        .leave-type-btn.selected { background-color: var(--primary-color); color: white; font-weight: 600; }
        .form-actions { text-align: right; }
        .form-actions .action-btn { color: white; background-color: var(--primary-color); }
        .leave-history .card { display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 600; color: white; }
        .status-승인 { background-color: #28a745; } .status-반려 { background-color: #dc3545; } .status-신청 { background-color: #ffc107; }
        .teacher-header { padding: 0 30px; background-color: #343a40; min-height: 60px; display: flex; justify-content: flex-end; align-items: center; }
        .teacher-header .user-name-logout { color: white; }
        .teacher-header .user-name-logout a { color: #adb5bd; }
        .routine-tasks-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .routine-item { background: #f1f3f5; border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 15px; display: inline-flex; align-items: center; cursor: pointer; }
        .routine-item.completed { background-color: #e0e7ff; border-color: var(--primary-color); color: var(--primary-color); font-weight: 500; }
        .routine-checkbox { display: none; }
        .accordion-item { margin-bottom: 5px; }
        .accordion-title { background: #f8f9fa; border-radius: 8px; padding: 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-title.active::after { transform: rotate(180deg); }
        .accordion-title::after { content: '▼'; transition: transform 0.2s; }
        .accordion-content { display: none; padding: 15px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; }
        .teacher-leave-card { display: flex; flex-direction: column; gap: 10px; }
        .leave-reason-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .leave-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .approve-btn { background: #28a745; } .reject-btn { background: #dc3545; }
        .post-filter-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .post-search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .post-filter-tabs { display: flex; }
        .post-filter-btn { padding: 8px 14px; border: 1px solid #ccc; background-color: var(--white-bg); cursor: pointer; border-radius: 0; }
        .post-filter-btn:first-child { border-radius: 6px 0 0 6px;} .post-filter-btn:last-child { border-radius: 0 6px 6px 0; border-left: none; }
        .post-filter-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .teacher-dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--white-bg); padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 500px; }
        .modal-close-btn { float: right; background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-light); }
    </style>
</head>
<body>
    <div class="container">
        <div id="app-root">
             <div class="empty-state"><div id="gsi-container"></div></div>
        </div>
    </div>
    <div id="new-post-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">×</button>
            <h2>✨ 새 게시물/업무 등록</h2>
            <form id="new-post-form" style="margin-top: 20px;">
                <div class="form-group"><label>유형</label><select name="type"><option value="공지">공지</option><option value="할일">할 일</option></select></div>
                <div class="form-group"><label>제목</label><input type="text" name="title" required></div>
                <div class="form-group"><label>내용</label><textarea name="content" rows="4"></textarea></div>
                <div class="form-group"><label>링크 (선택)</label><input type="url" name="link"></div>
                <div class="form-actions"><button type="submit" class="action-btn">등록하기</button></div>
            </form>
        </div>
    </div>

<script>
// [로그인 오류 해결 최종 스크립트]

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgr1HhCTgNnbj1umxlhVPOavO-BCTJOCZN2AZgMtAXiwwCeZFYcsmLOA4-8rR7fCeE/exec';
const GOOGLE_CLIENT_ID = '209932065927-v6kg2bd8gmgfdrksaqrhb7lqo12j6vrf.apps.googleusercontent.com';

let currentUser = null;
let completedItems = {};
const urlParams = new URLSearchParams(window.location.search);
const isTeacherMode = urlParams.get('mode') === 'teacher';

// ★★★ 수정된 window.onload 함수 ★★★
window.onload = function() {
    try { 
        currentUser = JSON.parse(localStorage.getItem('userInfo')); 
    } catch (e) { 
        localStorage.removeItem('userInfo');
        currentUser = null;
    }
    loadCompletedItems();

    if (currentUser) {
        // 이미 로그인 정보가 있으면 바로 데이터 로드
        loadData();
    } else {
        // 로그인 정보가 없으면 구글 로그인 초기화 및 버튼 표시
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID, 
            callback: handleCredentialResponse, 
            ux_mode: 'redirect',
            login_uri: window.location.origin + window.location.pathname + (isTeacherMode ? '?mode=teacher' : '')
        });
        google.accounts.id.prompt((n) => { 
            if (n.isNotDisplayed()) { 
                google.accounts.id.renderButton(document.getElementById('gsi-container'), { theme: 'outline', size: 'large' }); 
            }
        });
    }
    setupEventListeners();
};

async function loadData() {
    const root = document.getElementById('app-root');
    root.innerHTML = '<div class="empty-state">🔄 데이터를 불러오는 중...</div>';
    const fullUrl = `${SCRIPT_URL}?v=${new Date().getTime()}&email=${encodeURIComponent(currentUser.email)}` + (isTeacherMode ? '&mode=teacher' : '');
    try {
        const response = await fetch(fullUrl);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        currentUser = { ...currentUser, ...data.user };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        if (isTeacherMode) {
            root.innerHTML = renderTeacherDashboard(data);
        } else {
            root.innerHTML = renderStudentPortal(data);
        }
        renderUserInfo(currentUser);
    } catch (error) {
        root.innerHTML = `<div class="empty-state">❌ 데이터 로드 실패: ${error.message}</div>`;
    }
}

function setupEventListeners() {
    document.body.addEventListener('click', function(e) {
        const target = e.target;
        if (target.closest('.tab-button')) {
            const button = target.closest('.tab-button');
            const targetPaneId = button.dataset.tab;
            const tabContainer = button.closest('.tabs');
            tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const contentContainer = tabContainer.nextElementSibling;
            contentContainer.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(targetPaneId).classList.add('active');
        }
        if (target.closest('.accordion-title')) { target.closest('.accordion-title').classList.toggle('active'); const content = target.closest('.accordion-title').nextElementSibling; if (content) { content.style.display = content.style.display === 'block' ? 'none' : 'block'; } }
        if (target.closest('#new-post-btn')) { document.getElementById('new-post-modal').style.display = 'flex'; }
        if (target.closest('.modal-close-btn')) { target.closest('.modal-overlay').style.display = 'none'; }
        if (target.closest('.leave-type-btn')) { document.querySelectorAll('.leave-type-btn').forEach(btn => btn.classList.remove('selected')); target.classList.add('selected'); }
    });
    document.body.addEventListener('submit', function(e) { if (e.target.id === 'leave-request-form') { e.preventDefault(); submitLeaveRequest(e.target); } if (e.target.id === 'new-post-form') { e.preventDefault(); submitNewPost(e.target); } });
}

function renderStudentPortal(data) {
    return `
        <div class="student-header"><div id="user-display"></div></div>
        <div class="header">
            <h1>📢 오늘의 알림</h1>
            <div class="date-display">${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</div>
        </div>
        <div class="content">
            ${renderWidgets(data.widgets)}
            ${renderUnsubmitted(data.unsubmitted)}
            ${renderStudentClassSchedules(data.classSchedules)}
            <div class="tabs">
                <button class="tab-button active" data-tab="main-pane">알림 & 할 일</button>
                <button class="tab-button" data-tab="leave-pane" style="${data.user?.studentId ? '' : 'display:none;'}">외출/조퇴</button>
                <button class="tab-button" data-tab="resource-pane" style="${(data.resources || []).length > 0 ? '' : 'display:none;'}">자료실</button>
            </div>
            <div class="tab-content">
                <div id="main-pane" class="tab-pane active">${renderItemsSection('notices', data.notices, '📌 중요 공지')} ${renderItemsSection('tasks', data.tasks, '✅ 오늘의 할 일')}</div>
                <div id="leave-pane" class="tab-pane">${renderLeaveSection(data.leaveRequests)}</div>
                <div id="resource-pane" class="tab-pane">${renderResources(data.resources)}</div>
            </div>
        </div>
    `;
}

function renderTeacherDashboard(data) {
    return `
        <div class="teacher-header"><div id="user-display"></div></div>
        <div class="header">
            <h1>💼 업무 대시보드</h1>
            <div class="date-display">${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</div>
        </div>
        <div class="content">
            ${renderTeacherRoutines(data.routines)}
            ${renderClassManagement(data)}
            ${renderTeacherPersonalTasks(data.teacherPersonalTasks)}
            ${renderTeacherSettings(data)}
        </div>
    `;
}

function loadCompletedItems() { const todayStr = new Date().toISOString().split('T')[0]; const storedData = localStorage.getItem('completedItems'); if (storedData) { try { const data = JSON.parse(storedData); if (data.date === todayStr) { completedItems = data.items || {}; } else { localStorage.removeItem('completedItems'); completedItems = {}; } } catch (e) { localStorage.removeItem('completedItems'); completedItems = {}; } } }
function saveCompletedItems() { localStorage.setItem('completedItems', JSON.stringify({ date: new Date().toISOString().split('T')[0], items: completedItems }));}
async function handleCredentialResponse(response) { if (response && response.credential) { const userObject = JSON.parse(atob(response.credential.split('.')[1])); currentUser = { name: userObject.name, email: userObject.email, picture: userObject.picture }; localStorage.setItem('userInfo', JSON.stringify(currentUser)); const cleanUrl = window.location.origin + window.location.pathname + (isTeacherMode ? '?mode=teacher' : ''); window.location.href = cleanUrl; } }
function handleLogout() { localStorage.clear(); google.accounts.id.disableAutoSelect(); location.reload(); }
function renderUserInfo(user) { const displayEl = document.getElementById('user-display'); if (!displayEl) return; let userInitial = ''; const nameParts = (user.name || '').split(''); if (nameParts.length > 1) { userInitial = nameParts[0] + nameParts[nameParts.length - 1]; } else { userInitial = nameParts[0] || ''; } const userProfileHtml = user.picture ? `<img src="${user.picture}" class="user-profile-image" alt="profile">` : `<div class="user-initial">${userInitial}</div>`; displayEl.innerHTML = `<div class="user-display">${userProfileHtml}<div class="user-name-logout"><strong>${user.name}</strong><a href="#" onclick="handleLogout()">로그아웃</a></div></div>`; }
function renderWidgets(widgets) { if (!widgets || widgets.length === 0) return ''; const widgetHtml = widgets.map(widget => { let contentHtml = widget.내용 || ''; if (widget.위젯종류 === '디데이') { const targetDate = new Date(contentHtml); const today = new Date(); today.setHours(0, 0, 0, 0); const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)); contentHtml = diff === 0 ? "D-Day" : diff > 0 ? `D-${diff}` : `D+${-diff}`; } return `<div class="widget"><div class="widget-title">${widget.제목 || ''}</div><div class="widget-content">${contentHtml}</div></div>`; }).join(''); return `<div id="widgets-container">${widgetHtml}</div>`;}
function renderUnsubmitted(tasks) { if (!tasks || tasks.length === 0) return ''; const listHtml = tasks.map(t => `<li>👌 ${t.제목 || t.내용 || ''}</li>`).join(''); return `<div class="unsubmitted-section"><p>🔔 아직 완료하지 않은 할 일이 있어요!</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">${listHtml}</ul></div>`;}
function renderStudentClassSchedules(schedules) { if (!schedules || schedules.length === 0) return ''; const schedulesHtml = schedules.map(s => `<div class="card"><p>${s.제목 || ''}</p></div>`).join(''); return `<div class="section"><h2 class="section-title">🗓️ 학급 일정</h2><div class="grid-container">${schedulesHtml}</div></div>`;}
function renderItemsSection(type, items, sectionTitle) { const unreadItems = (items || []).filter(item => !completedItems[item.id]); if (unreadItems.length === 0) { return `<div class="section"><h2 class="section-title">${sectionTitle}</h2><div class="empty-state">모두 확인했습니다! 👍</div></div>`; } const itemsHtml = unreadItems.map(item => { const isTask = type === 'tasks'; const actionButton = isTask ? `<a href="${item.링크 || '#'}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">기록하기</a>` : (item.링크 ? `<a href="${item.링크}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">바로가기</a>` : ''); return `<div class="notice-item card" id="${item.id}"><div style="flex-grow: 1;"><div class="card-title">${item.아이콘 || ''} ${item.제목 || ''}</div><p class="card-description">${item.내용 || ''}</p>${actionButton}</div><button class="complete-btn" onclick="completeItem('${item.id}')">확인</button></div>`; }).join(''); return `<div class="section"><h2 class="section-title">${sectionTitle}</h2>${itemsHtml}</div>`;}
function completeItem(itemId) { completedItems[itemId] = true; saveCompletedItems(); const itemElement = document.getElementById(itemId); if (itemElement) { itemElement.style.transition = 'opacity 0.3s, transform 0.3s'; itemElement.style.opacity = '0'; itemElement.style.transform = 'translateY(-10px)'; setTimeout(() => { itemElement.remove(); }, 300); } }
function renderLeaveSection(requests) { const todayStr = new Date().toISOString().split('T')[0]; const historyHtml = (!requests || requests.length === 0) ? '<div class="empty-state">신청 내역이 없습니다.</div>' : requests.map(req => { const requestDate = req.희망일자 ? new Date(req.희망일자) : null; const requestDateStr = requestDate ? requestDate.toISOString().split('T')[0] : ''; const certButton = (req.상태 === '승인' && req.신청행번호 && requestDateStr === todayStr) ? `<a href="${SCRIPT_URL}?action=getCertificate&rowNum=${req.신청행번호}" target="_blank" class="action-btn" style="background-color:#17a2b8; padding: 5px 10px; font-size: 0.8em; margin: 0;">확인증</a>` : ''; return `<div class="card"><div><strong>${req.신청종류}</strong> (${requestDate ? requestDate.toLocaleDateString() : '날짜 없음'})<br><small>사유: ${req.사유 || ''}</small></div><div style="display: flex; align-items: center; gap: 10px;"><span class="status-badge status-${req.상태}">${req.상태}</span>${certButton}</div></div>`; }).join(''); return `<div class="leave-form"><h2 class="section-title" style="border: none; margin-bottom: 20px;">외출/조퇴 신청하기</h2><form id="leave-request-form"><div class="form-group"><label>신청 종류</label><div class="leave-type-buttons"><button type="button" class="leave-type-btn selected" data-type="외출">외출</button><button type="button" class="leave-type-btn" data-type="조퇴">조퇴</button></div></div><div class="form-group"><label>희망 일자</label><input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required></div><div class="form-group"><label>사유</label><textarea name="reason" rows="3" required></textarea></div><div class="form-actions"><button type="submit" class="action-btn">신청 제출</button></div></form></div><div class="section leave-history"><h2 class="section-title">나의 신청 내역</h2>${historyHtml}</div>`;}
function renderResources(resources) { if (!resources || resources.length === 0) return '<div class="empty-state">등록된 자료가 없습니다.</div>'; const resourcesHtml = resources.map(res => `<div class="card"><a href="${res.링크 || '#'}" target="_blank" style="text-decoration: none; color: var(--primary-color); font-weight: 600;">${res.자료명 || ''}</a></div>`).join(''); return `<div class="section grid-container">${resourcesHtml}</div>`;}
async function submitLeaveRequest(form) { const type = form.querySelector('.leave-type-btn.selected')?.dataset.type; if (!type) { alert('신청 종류(외출 또는 조퇴)를 선택해주세요.'); return; } const params = new URLSearchParams({ action: 'submitLeaveRequest', studentId: currentUser.studentId, name: currentUser.name, email: currentUser.email, type: type, date: form.date.value, reason: form.reason.value }); alert('신청 처리 중...'); try { const res = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await res.json(); alert(result.message); if (result.status === 'success') loadData(); } catch (error) { alert('신청 중 오류: ' + error.message); } }
function renderTeacherRoutines(routines) { if (!routines || routines.length === 0) return ''; const routineHtml = routines.map(r => `<label class="routine-item ${completedItems[r.rowNum] ? 'completed' : ''}" onclick="toggleRoutineComplete(this, '${r.rowNum}')"><input type="checkbox" class="routine-checkbox" ${completedItems[r.rowNum] ? 'checked' : ''}><span>${r.업무명}</span></label>`).join(''); return `<div class="section"><h2 class="section-title">☀️ 오늘의 루틴 업무</h2><div class="routine-tasks-container">${routineHtml}</div></div>`;}
function renderClassManagement(data) { const allPosts = [...(data.allNotices || []), ...(data.allTasks || [])]; return `<div class="section"><h2 class="section-title">🏠 학급 관리</h2><div class="accordion-item"><div class="accordion-title">⏰ 외출/조퇴 신청 (${(data.pendingLeaveRequests || []).length}건)</div><div class="accordion-content">${renderLeaveCards(data.pendingLeaveRequests)}</div></div><div class="accordion-item"><div class="accordion-title">📝 과제별 제출 현황 (${(data.assignments || []).length}건)</div><div class="accordion-content">${renderAssignmentCards(data.assignments)}</div></div><div class="accordion-item"><div class="accordion-title">📢 알림 포털 게시 현황 (${allPosts.length}건)</div><div class="accordion-content">${renderPostStatusCards(allPosts)}</div></div><div class="accordion-item"><div class="accordion-title">📅 전체 학급 일정 (${(data.classSchedules || []).length}건)</div><div class="accordion-content">${renderScheduleCards(data.classSchedules)}</div></div></div>`;}
function renderLeaveCards(leaves) { if (!leaves || leaves.length === 0) return '<div class="empty-state" style="padding: 20px;">신청 내역이 없습니다.</div>'; return leaves.map(req => `<div class="teacher-leave-card card"><div class="leave-header" style="display:flex; justify-content:space-between; align-items:center;"><strong>${req.이름 || ''}(${req.학번 || ''})</strong><small>${req.신청종류}(${new Date(req.희망일자).toLocaleDateString()})</small></div><textarea class="leave-reason-input">${req.사유 || ''}</textarea><div class="leave-actions"><button class="action-btn approve-btn" onclick="updateLeaveStatus(${req.rowNum}, '승인', this)">승인</button><button class="action-btn reject-btn" onclick="updateLeaveStatus(${req.rowNum}, '반려', this)">반려</button></div></div>`).join('');}
function renderAssignmentCards(assignments) { if (!assignments || assignments.length === 0) return '<div class="empty-state" style="padding: 20px;">관리할 과제가 없습니다.</div>'; return assignments.map(a => `<div class="card">${a.title}</div>`).join('');}
function renderPostStatusCards(posts) { if (!posts || posts.length === 0) return '<div class="empty-state" style="padding: 20px;">게시된 알림/할 일이 없습니다.</div>'; const postListHtml = posts.sort((a, b) => b.rowNum - a.rowNum).map(item => `<div class="card post-status-card" style="display:flex; justify-content:space-between; align-items:center;" data-title="${(item.제목 || '').toLowerCase()}" data-status="${item.게시여부}"><span>${item.제목}</span><label class="toggle-switch"><input type="checkbox" onchange="updatePostStatus(this, ${item.rowNum})" ${item.게시여부 === 'Y' ? 'checked' : ''}><span class="slider"></span></label></div>`).join(''); return `<div class="post-filter-controls"><input type="search" class="post-search-input" placeholder="제목으로 검색..." oninput="applyPostFilters(this.closest('.accordion-content'))"><div class="post-filter-tabs"><button class="post-filter-btn active" data-filter="all" onclick="handleFilterButtonClick(this)">전체</button><button class="post-filter-btn" data-filter="Y" onclick="handleFilterButtonClick(this)">게시중</button><button class="post-filter-btn" data-filter="N" onclick="handleFilterButtonClick(this)">숨김</button></div></div><div class="post-list-container">${postListHtml}</div><div class="empty-state post-filter-empty" style="display:none; padding: 20px;">검색 결과가 없습니다.</div>`;}
function renderScheduleCards(schedules) { if (!schedules || schedules.length === 0) return '<div class="empty-state" style="padding: 20px;">등록된 학급 일정이 없습니다.</div>'; return schedules.map(s => `<div class="card">${s.제목}</div>`).join('');}
function renderTeacherPersonalTasks(tasks) { if (!tasks || tasks.length === 0) return ''; let tasksHtml = tasks.map(task => `<div class="card"><div class="card-title">${task.내용}</div>${task.링크 ? `<a href="${task.링크}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">바로가기</a>` : ''}</div>`).join(''); return `<div class="section"><h2 class="section-title">📋 업무 일지</h2><div class="grid-container">${tasksHtml}</div></div>`;}
function renderTeacherSettings(data) { const groupedItems = (data.dashboardItems || []).reduce((acc, item) => { const type = item.종류 || '기타'; if (!acc[type]) acc[type] = []; acc[type].push(item); return acc; }, {}); const tabs = Object.keys(groupedItems); const tabButtonsHtml = tabs.map((tab, i) => `<button class="tab-button ${i === 0 ? 'active' : ''}" data-tab="teacher-tab-${i}">${tab}</button>`).join(''); const tabPanesHtml = tabs.map((tab, i) => { const itemsHtml = groupedItems[tab].map(item => `<a href="${item.링크 || '#'}" target="_blank" class="card"><div class="card-title">${item.업무명}</div><p class="card-description">${item.상세내용 || ''}</p></a>`).join(''); const activeClass = i === 0 ? 'active' : ''; return `<div id="teacher-tab-${i}" class="tab-pane ${activeClass} grid-container">${itemsHtml}</div>`; }).join(''); return `<div class="section"><h2 class="section-title">⚙️ 설정</h2><div class="teacher-dashboard-grid"><div id="new-post-btn" class="card" style="cursor:pointer; text-align:center; display:flex; align-items:center; justify-content:center;"><div class="card-title">✨ 새 게시물/업무 등록</div></div><a href="${data.sheetUrl}" target="_blank" class="card" style="display:flex; align-items:center; justify-content:center;"><div class="card-title">📊 데이터 시트 수정</div></a></div><div class="tabs">${tabButtonsHtml}</div><div class="tab-content">${tabPanesHtml}</div></div>`;}
async function updateLeaveStatus(rowNum, status, button) { const reasonInput = button.closest('.teacher-leave-card').querySelector('.leave-reason-input'); const modifiedReason = reasonInput ? reasonInput.value : ''; const params = new URLSearchParams({ action: 'updateLeaveStatus', rowNum, status, modifiedReason }); alert('처리 중...'); try { const res = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await res.json(); alert(result.message); if (result.status === 'success') loadData(); } catch (error) { alert('처리 중 오류: ' + error.message); } }
function toggleRoutineComplete(label, itemId) { const checkbox = label.querySelector('.routine-checkbox'); checkbox.checked = !checkbox.checked; if (checkbox.checked) { completedItems[itemId] = true; label.classList.add('completed'); } else { delete completedItems[itemId]; label.classList.remove('completed'); } saveCompletedItems();}
async function updatePostStatus(checkbox, rowNum) { const newStatus = checkbox.checked ? 'Y' : 'N'; const card = checkbox.closest('.post-status-card'); card.dataset.status = newStatus; card.style.opacity = '0.5'; const params = new URLSearchParams({ action: 'updatePostStatus', rowNum, newStatus }); try { const response = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await response.json(); if (result.status !== 'success') throw new Error(result.message); } catch (error) { alert(`오류: ${error.message}`); checkbox.checked = !checkbox.checked; card.dataset.status = checkbox.checked ? 'Y' : 'N'; } finally { card.style.opacity = '1'; } }
async function submitNewPost(form) { const formData = new FormData(form); const params = new URLSearchParams({ action: 'createNewPost', ...Object.fromEntries(formData.entries()) }); const submitButton = form.querySelector('button[type="submit"]'); submitButton.textContent = '등록 중...'; submitButton.disabled = true; try { const response = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await response.json(); if (result.status !== 'success') { throw new Error(result.message); } alert(result.message); document.getElementById('new-post-modal').style.display = 'none'; form.reset(); loadData(); } catch (error) { alert('오류: ' + error.message); } finally { submitButton.textContent = '등록하기'; submitButton.disabled = false; } }
function handleFilterButtonClick(buttonEl) { const container = buttonEl.closest('.post-filter-tabs'); container.querySelectorAll('.post-filter-btn').forEach(btn => btn.classList.remove('active')); buttonEl.classList.add('active'); applyPostFilters(buttonEl.closest('.accordion-content')); }
function applyPostFilters(containerEl) { const searchTerm = (containerEl.querySelector('.post-search-input') || {value: ''}).value.toLowerCase(); const activeFilter = (containerEl.querySelector('.post-filter-btn.active') || {dataset: {filter: 'all'}}).dataset.filter; const allPosts = containerEl.querySelectorAll('.post-status-card'); let visibleCount = 0; allPosts.forEach(post => { const title = post.dataset.title || ''; const status = post.dataset.status || ''; const matchesSearch = title.includes(searchTerm); const matchesFilter = (activeFilter === 'all' || status === activeFilter); if (matchesSearch && matchesFilter) { post.style.display = 'flex'; visibleCount++; } else { post.style.display = 'none'; } }); const emptyState = containerEl.querySelector('.post-filter-empty'); if (emptyState) { emptyState.style.display = visibleCount === 0 ? 'block' : 'none'; } }
</script>
</body>
</html>
