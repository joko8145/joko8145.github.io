<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïö∞Î¶¨ Î∞ò ÏïåÎ¶º Ìè¨ÌÑ∏</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --primary-color: #667eea; --secondary-color: #764ba2; --light-bg: #f8f9fa; --white-bg: rgba(255, 255, 255, 0.97); --text-dark: #333; --text-light: #555; --border-radius: 12px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; color: var(--text-dark); }
        .container { max-width: 800px; margin: 0 auto; background: var(--white-bg); border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .auth-container { padding: 10px 30px; text-align: right; background-color: #343a40; min-height: 50px; display: flex; justify-content: flex-end; align-items: center; }
        .user-info { color: white; padding: 8px 15px; display: inline-block; font-size: 0.9em; }
        .user-info img { width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
        .user-info a { color: #fff; text-decoration: none; margin-left: 10px; font-weight: bold; border-bottom: 1px dotted white;}
        #gsi-container { display: inline-block; }
        .header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 40px 30px; text-align: center; }
        .header h1 { font-size: 2.8em; margin-bottom: 10px; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .date-display { font-size: 1.3em; opacity: 0.9; }
        .content { padding: 30px; }
        .section { margin-bottom: 40px; }
        .section-title { font-size: 1.5em; font-weight: bold; color: var(--text-dark); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid var(--primary-color); display: flex; align-items: center; }
        .section-title .icon { margin-right: 10px; }
        .empty-state { text-align: center; padding: 40px; color: #666; font-size: 1.1em; background-color: #f8f9fa; border-radius: 8px; }
        .notice-item, .teacher-leave-card, .assignment-card { background: white; border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; overflow: hidden; border-left: 4px solid var(--primary-color); }
        .notice-title { font-size: 1.25em; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; }
        .notice-title .icon { margin-right: 8px; }
        .notice-content { font-size: 1.1em; line-height: 1.7; color: var(--text-light); }
        .notice-image { max-width: 100%; border-radius: 8px; margin-top: 15px; margin-bottom: 15px; display: block; }
        .notice-link, .certificate-link, .teacher-card-button { display: inline-block; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; padding: 10px 18px; border-radius: 25px; margin-top: 15px; cursor: pointer; border: none; font-weight: 500; transition: all 0.2s ease; text-decoration: none; }
        .notice-link:hover, .certificate-link:hover, .teacher-card-button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .certificate-link { background: #17a2b8; margin-left: 10px; }
        .unsubmitted-section { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: var(--border-radius); padding: 20px; margin-bottom: 30px; }
        .unsubmitted-title { font-weight: bold; color: #856404; margin-bottom: 10px; font-size: 1.2em; }
        .subtask-list, .unsubmitted-list { list-style: none; margin: 15px 0 0 5px; padding: 0;}
        .subtask-item { display: flex; align-items: center; margin-bottom: 10px; }
        .subtask-checkbox { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; accent-color: var(--secondary-color); flex-shrink: 0; }
        .subtask-label { flex-grow: 1; }
        .subtask-item.completed .subtask-label { text-decoration: line-through; color: #aaa; }
        .leave-request-buttons { display: flex; gap: 10px; }
        .leave-request-btn { flex: 1; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; background: transparent; border: 2px solid var(--secondary-color); color: var(--secondary-color); transition: all 0.2s ease-in-out; }
        .leave-request-btn:hover { background: var(--secondary-color); color: white; }
        .leave-status { padding: 3px 8px; border-radius: 5px; color: white; font-size: 0.8em; }
        .status-pending { background-color: #ffc107; } .status-approved { background-color: #28a745; } .status-rejected { background-color: #dc3545; }
        .leave-history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .leave-history-item:first-child { padding-top: 0; }
        .leave-history-item + .leave-history-item { border-top: 1px solid #eee; }
        .leave-comment { font-size: 0.9em; color: #6c757d; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 8px;}
        .teacher-dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .teacher-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid var(--primary-color); transition: all 0.2s ease; display: block; position: relative; text-decoration: none; }
        .teacher-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .teacher-card-title { font-weight: 700; font-size: 1.3em; color: var(--primary-color); margin-bottom: 5px; text-decoration: none; }
        .teacher-card p { margin-bottom: 15px; color: var(--text-light); flex-grow: 1; text-decoration: none; }
        .form-creator input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; font-size: 1em;}
        .form-creator button { width: 100%; padding: 10px 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; font-size: 1em; }
        .leave-comment-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; }
        .leave-actions, .assignment-actions { text-align: right; margin-top: 15px; }
        .leave-actions button, .assignment-actions button { padding: 8px 12px; margin-left: 5px; border: none; border-radius: 5px; color: white; cursor: pointer; }
        .approve-btn, .check-btn { background: #28a745; } .reject-btn { background: #dc3545; } .response-btn { background: #007bff; }
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; }
        .routine-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; transition: color 0.2s, background-color 0.2s; background: white; border-radius: 8px; margin-bottom: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        .routine-item:last-child { border-bottom: none; }
        .routine-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; cursor: pointer; accent-color: var(--primary-color); }
        .routine-item label { font-size: 1.1em; flex-grow: 1; cursor: pointer; }
        .routine-item.completed label { text-decoration: line-through; color: #aaa; }
        .complete-btn, .teacher-complete-btn { position: absolute; top: 15px; right: 15px; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 28px; text-align: center; opacity: 0.7; transition: opacity 0.2s;}
        .complete-btn:hover, .teacher-complete-btn:hover { opacity: 1; }
        .complete-btn { background: #28a745; }
        .teacher-complete-btn { background: #dc3545; font-size: 18px; }
    </style>
</head>
<body>
    <div id="modal-overlay">
        <div id="modal-content">
            <h2 id="modal-title">Ïô∏Ï∂ú Ïã†Ï≤≠</h2>
            <form id="leave-request-form">
                <input type="hidden" id="leave-type" name="type">
                <div>
                    <label for="leave-date">Ìù¨Îßù ÏùºÏûê</label>
                    <input type="date" id="leave-date" name="date" required>
                </div>
                <div>
                    <label for="leave-reason">ÏÇ¨Ïú†</label>
                    <textarea id="leave-reason" name="reason" rows="4" required></textarea>
                </div>
                <div id="modal-buttons">
                    <button type="button" id="closeModal">Ï∑®ÏÜå</button>
                    <button type="button" id="submitLeave">Ï†úÏ∂ú</button>
                </div>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="auth-container"><div id="user-display" style="display: none;"></div><div id="gsi-container"></div></div>
        <div class="header"><h1 id="portal-title">üì¢ Ïò§ÎäòÏùò ÏïåÎ¶º</h1><div class="date-display" id="dateDisplay"></div></div>
        <div class="content">
            <div id="student-portal">
                <div id="unsubmitted-container"></div>
                <div class="section"><h2 class="section-title"><span class="icon">üì¢</span>Ï§ëÏöî Í≥µÏßÄÏÇ¨Ìï≠</h2><div id="notices"></div></div>
                <div class="section"><h2 class="section-title"><span class="icon">‚úÖ</span>Ïò§ÎäòÏùò Ìï† Ïùº</h2><div id="tasks"></div></div>
                <div id="leave-section" style="display: none;">
                    <div class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 class="section-title" style="margin: 0; border: none; padding: 0;"><span class="icon">‚úàÔ∏è</span>Ïô∏Ï∂ú/Ï°∞Ìá¥</h2>
                            <div class="leave-request-buttons">
                                <button class="leave-request-btn" id="request-go-out">Ïô∏Ï∂ú</button>
                                <button class="leave-request-btn" id="request-early-leave">Ï°∞Ìá¥</button>
                            </div>
                        </div>
                        <div id="leave-requests"></div>
                    </div>
                </div>
                <div class="section"><h2 class="section-title"><span class="icon">üìö</span>Ïö∞Î¶¨ Î∞ò ÏûêÎ£åÏã§</h2><div id="resources" class="resource-grid"></div></div>
            </div>
            <div id="teacher-dashboard" style="display: none;">
                <div id="routine-tasks-section" class="section"></div>
                <div id="teacher-admin-section"></div>
                <div class="section" id="assignment-section"><div class="section-title"><span class="icon">üìù</span>Í≥ºÏ†úÎ≥Ñ Ï†úÏ∂ú ÌòÑÌô©</div><div id="assignment-status"></div></div>
                <div class="section" id="pending-leave-section"><div class="section-title"><span class="icon">‚è∞</span>Ïô∏Ï∂ú/Ï°∞Ìá¥ Ïã†Ï≤≠ ÌôïÏù∏</div><div id="pending-leave-requests"></div></div>
                <div id="teacher-links"></div>
            </div>
        </div>
    </div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdQuAq2nW8MHcdx1x5tPWhfv5uPkD-8qY6zU5piXh1GZrVi1SnN6OBapFr03kt8pQq/exec';
    const GOOGLE_CLIENT_ID = '190435721099-45et34v9elbvod5lb84ddakrnenh5039.apps.googleusercontent.com';

    let currentUser = null;
    let submittedTasks = new Set();
    let completedItems = {};

    const urlParams = new URLSearchParams(window.location.search);
    const isTeacherMode = urlParams.get('mode') === 'teacher';

    window.onload = function () {
        loadCompletedItems();
        google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
        const storedUser = localStorage.getItem('userInfo');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            renderUserInfo(currentUser);
            loadData();
        } else {
            google.accounts.id.renderButton(document.getElementById("gsi-container"), { theme: "outline", size: "large", text: "signin_with", shape: "pill" });
            if (!isTeacherMode) {
                loadData();
            } else {
                const teacherDashboard = document.getElementById('teacher-dashboard');
                if(teacherDashboard) {
                    teacherDashboard.style.display = 'block';
                    document.getElementById('student-portal').style.display = 'none';
                    teacherDashboard.innerHTML = '<div class="empty-state">ÍµêÏÇ¨ Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.</div>';
                }
            }
        }
        updateDateDisplay();
        setupEventListeners();
    };

    function loadCompletedItems() {
        const todayStr = new Date().toISOString().split('T')[0];
        const storedData = localStorage.getItem('completedItems');
        if (storedData) {
            const data = JSON.parse(storedData);
            if (data.date === todayStr) {
                completedItems = data.items || {};
            } else {
                localStorage.removeItem('completedItems');
            }
        }
    }

    function saveCompletedItems() {
        const todayStr = new Date().toISOString().split('T')[0];
        localStorage.setItem('completedItems', JSON.stringify({
            date: todayStr,
            items: completedItems
        }));
    }
    
    function setupEventListeners() {
        const goOutBtn = document.getElementById('request-go-out');
        if (goOutBtn) goOutBtn.addEventListener('click', () => openLeaveModal('Ïô∏Ï∂ú'));
        
        const earlyLeaveBtn = document.getElementById('request-early-leave');
        if(earlyLeaveBtn) earlyLeaveBtn.addEventListener('click', () => openLeaveModal('Ï°∞Ìá¥'));

        const closeModalBtn = document.getElementById('closeModal');
        if(closeModalBtn) closeModalBtn.addEventListener('click', () => document.getElementById('modal-overlay').style.display = 'none');

        const submitLeaveBtn = document.getElementById('submitLeave');
        if(submitLeaveBtn) submitLeaveBtn.addEventListener('click', submitLeaveRequest);
    }

    function openLeaveModal(type) {
        document.getElementById('modal-title').textContent = `${type} Ïã†Ï≤≠`;
        document.getElementById('leave-type').value = type;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('leave-date').value = today;
        document.getElementById('leave-reason').value = '';
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    
    async function handleCredentialResponse(response) {
        const userObject = JSON.parse(atob(response.credential.split('.')[1]));
        currentUser = { name: userObject.name, email: userObject.email, picture: userObject.picture, studentId: null, isTeacher: false };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        location.reload();
    }

    function handleLogout() {
        localStorage.removeItem('userInfo');
        currentUser = null;
        google.accounts.id.disableAutoSelect();
        location.reload();
    }

    function renderUserInfo(user) {
        const displayEl = document.getElementById('user-display');
        const gsiContainer = document.getElementById('gsi-container');
        if(!displayEl || !gsiContainer) return;
        displayEl.style.display = 'block';
        gsiContainer.style.display = 'none';
        let userInfoHtml = `<span class="user-info"><img src="${user.picture}" alt="profile"><strong>${user.name}</strong>Îãò <a href="#" onclick="handleLogout()">Î°úÍ∑∏ÏïÑÏõÉ</a></span>`;
        if (user.studentId === null && !user.isTeacher) {
            userInfoHtml += ` <span class="user-info" style="color: #ffc107;">(ÎØ∏Îì±Î°ù)</span>`;
        }
        displayEl.innerHTML = userInfoHtml;
    }

    async function loadData() {
        let fullUrl = `${SCRIPT_URL}?v=${new Date().getTime()}`;
        if (isTeacherMode) {
            document.getElementById('portal-title').textContent = 'üéì ÍµêÏÇ¨ ÌÜµÌï© ÎåÄÏãúÎ≥¥Îìú';
            fullUrl += '&mode=teacher';
        }
        if (currentUser) {
            fullUrl += `&email=${encodeURIComponent(currentUser.email)}`;
        }

        const studentPortal = document.getElementById('student-portal');
        const teacherDashboard = document.getElementById('teacher-dashboard');

        if (isTeacherMode) {
            studentPortal.style.display = 'none';
            teacherDashboard.style.display = 'block';
            document.getElementById('routine-tasks-section').innerHTML = '';
            document.getElementById('teacher-admin-section').innerHTML = '';
            document.getElementById('assignment-status').innerHTML = '<div class="empty-state">üîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
            document.getElementById('pending-leave-requests').innerHTML = '<div class="empty-state">üîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
            document.getElementById('teacher-links').innerHTML = '<div class="empty-state">üîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
        } else {
            studentPortal.style.display = 'block';
            teacherDashboard.style.display = 'none';
            ['notices', 'tasks', 'resources', 'leave-requests'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<div class="empty-state">üîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
            });
        }
        
        try {
            const response = await fetch(fullUrl);
            if (!response.ok) throw new Error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
            const data = await response.json();
            
            if (data.error) {
                if (isTeacherMode) teacherDashboard.innerHTML = `<div class="empty-state">‚ùå ${data.error}</div>`;
                else studentPortal.innerHTML = `<div class="empty-state">‚ùå ${data.error}</div>`;
                if(data.user) { currentUser.name = data.user.name; renderUserInfo(currentUser); }
                return;
            }

            currentUser = { ...currentUser, ...data.user };
            localStorage.setItem('userInfo', JSON.stringify(currentUser));
            renderUserInfo(currentUser);

            if (isTeacherMode) {
                renderTeacherDashboard(data);
            } else {
                if (data.user && data.user.studentId) {
                    document.getElementById('leave-section').style.display = 'block';
                } else {
                    document.getElementById('leave-section').style.display = 'none';
                }
                
                submittedTasks = new Set(data.submittedTasks || []);
                renderItems('notices', data.notices.filter(item => !completedItems[item.id]), 'ÏûêÏÑ∏Ìûà Î≥¥Í∏∞ ‚Üí');
                renderItems('tasks', data.tasks.filter(item => !completedItems[item.id]), 'Î∞îÎ°ú ÌïòÍ∏∞ ‚Üí', true);
                renderUnsubmitted(data.unsubmitted);
                renderResources(data.resources);
                renderLeaveRequests(data.leaveRequests);
            }

        } catch (error) {
            console.error('Error fetching data:', error);
            const targetEl = isTeacherMode ? teacherDashboard : document.getElementById('notices');
            if(targetEl) targetEl.innerHTML = `<div class="empty-state">‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®! (${error.message})</div>`;
        }
    }
    
    async function completeItem(itemId, isTeacherAction = false, rowNum, sheetName) {
        const itemElement = document.getElementById(itemId);
        if (!itemElement) return;
        const colName = (sheetName === '[Îç∞Ïù¥ÌÑ∞_ÏïåÎ¶º]') ? 'Í≤åÏãúÏó¨Î∂Ä' : 'ÏÉÅÌÉú';
        const value = (sheetName === '[Îç∞Ïù¥ÌÑ∞_ÏïåÎ¶º]') ? 'N' : 'ÏôÑÎ£å';

        if (isTeacherAction) {
            const params = new URLSearchParams({ action: 'updateTaskStatus', sheetName: sheetName, rowNum: rowNum, colName: colName, value: value });
            try {
                const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
                const result = await res.json();
                if (result.status !== 'success') throw new Error(result.message);
            } catch (err) {
                alert(`Ìï≠Î™© ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò: ${err.message}`);
                return;
            }
        } else {
            completedItems[itemId] = true;
            saveCompletedItems();
        }

        itemElement.style.transition = 'opacity 0.5s, transform 0.5s, max-height 0.5s, margin 0.5s, padding 0.5s';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'scale(0.95)';
        itemElement.style.maxHeight = '0px';
        itemElement.style.paddingTop = '0';
        itemElement.style.paddingBottom = '0';
        itemElement.style.marginBottom = '0';
        setTimeout(() => itemElement.remove(), 500);
    }

    async function handleSubmission(item) {
        if (!currentUser || !currentUser.studentId) return; 
        if (submittedTasks.has(item.taskId)) return; 
        const params = new URLSearchParams({
            action: 'logClick',
            studentId: currentUser.studentId,
            name: encodeURIComponent(currentUser.name),
            taskId: encodeURIComponent(item.taskId)
        });
        try {
            const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await response.json();
            if (result.status === 'success') {
                submittedTasks.add(item.taskId);
            }
        } catch (error) { console.error('Ï†úÏ∂ú Í∏∞Î°ù Ïò§Î•ò:', error); }
    }

    function renderItems(containerId, items, defaultButtonText, isTask = false) {
        const container = document.getElementById(containerId);
        if (!items || items.length === 0) {
            container.innerHTML = `<div class="empty-state">${containerId === 'notices' ? 'üìù Ïò§Îäò Îì±Î°ùÎêú Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.' : '‚úÖ Ïò§Îäò Ìï† ÏùºÏù¥ Î™®Îëê ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!'}</div>`;
            return;
        }
        container.innerHTML = items.map(item => {
            let completeButton = '';
            if (item.type !== 'Í≥µÏßÄ' && currentUser && currentUser.studentId) {
                 completeButton = `<button class="complete-btn" title="ÌôïÏù∏/ÏôÑÎ£å" onclick="completeItem('${item.id}')">‚úî</button>`;
            }
            if (isTeacherMode && item.type === 'Í≥µÏßÄ') {
                completeButton = `<button class="teacher-complete-btn" title="Í≤åÏãú Ï¢ÖÎ£å" onclick="completeItem('${item.id}', true, ${item.rowNum}, '[Îç∞Ïù¥ÌÑ∞_ÏïåÎ¶º]')">‚úñ</button>`;
            }

            const icon = item.icon ? `<span class="icon">${item.icon}</span>` : '';
            const title = item.title ? `<div class="notice-title">${icon}${item.title}</div>` : '';
            let contentHtml = '';
            const isChecklist = isTask && (item.type === 'Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏' || (!item.link && item.content.includes(',')));

            if (isChecklist && item.taskId) {
                const subtasks = item.content.split(',').map(s => s.trim());
                contentHtml = `<ul class="subtask-list">` + subtasks.map(subtask => {
                    const fullTaskId = `${item.taskId}_${subtask}`;
                    const isCompleted = submittedTasks.has(fullTaskId);
                    return `<li class="subtask-item ${isCompleted ? 'completed' : ''}"><input type="checkbox" class="subtask-checkbox" onchange="toggleSubtask(this, '${item.taskId}', '${subtask}')" ${isCompleted ? 'checked' : ''}><label class="subtask-label">${subtask}</label></li>`;
                }).join('') + `</ul>`;
            } else {
                const image = item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.title || 'ÏïåÎ¶º Ïù¥ÎØ∏ÏßÄ'}" class="notice-image">` : '';
                const content = item.content ? `<div class="notice-content">${item.content.replace(/\n/g, '<br>')}</div>` : '';
                let finalLink = item.link;
                if (isTask && finalLink && finalLink.includes('__STUDENT_ID__')) {
                    if (currentUser && currentUser.studentId) {
                        finalLink = finalLink.replace('__STUDENT_ID__', currentUser.studentId).replace('__STUDENT_NAME__', encodeURIComponent(currentUser.name));
                    } else { finalLink = null; }
                }
                let linkHtml = '';
                if (finalLink) {
                    const clickHandler = item.recordable ? `onclick="handleSubmission({taskId: '${item.taskId}'})"` : '';
                    linkHtml = `<a href="${finalLink}" class="notice-link" target="_blank" ${clickHandler}>${item.buttonText || defaultButtonText}</a>`;
                }
                contentHtml = image + content + linkHtml;
            }
            return `<div class="notice-item" id="${item.id}" data-rownum="${item.rowNum}">${completeButton}${title}${contentHtml}</div>`;
        }).join('');
    }

    async function toggleSubtask(checkbox, taskId, subtask) {
        if (!currentUser || !currentUser.studentId) { alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî."); checkbox.checked = !checkbox.checked; return; }
        const isChecked = checkbox.checked;
        const listItem = checkbox.closest('.subtask-item');
        listItem.style.opacity = '0.5';
        const params = new URLSearchParams({ action: 'logSubtask', studentId: currentUser.studentId, name: currentUser.name, taskId: taskId, subtask: subtask, isChecked: isChecked });
        try {
            const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            listItem.classList.toggle('completed', isChecked);
            const fullTaskId = `${taskId}_${subtask}`;
            if (isChecked) submittedTasks.add(fullTaskId); else submittedTasks.delete(fullTaskId);
        } catch (error) {
            alert(`Ïò§Î•ò: ${error.message}`); checkbox.checked = !isChecked;
        } finally { listItem.style.opacity = '1'; }
    }
    
    function renderUnsubmitted(tasks) {
        const container = document.getElementById('unsubmitted-container');
        if(!currentUser||!currentUser.studentId||!tasks||tasks.length===0) {
            container.style.display="none";
            return;
        }
        container.style.display="block";
        container.innerHTML=`<div class="unsubmitted-section"><div class="unsubmitted-title">üîî ${currentUser.name}Îãò, ÏïÑÏßÅ ÏôÑÎ£åÌïòÏßÄ ÏïäÏùÄ Ìï† ÏùºÏù¥ ÏûàÏñ¥Ïöî!</div><ul class="unsubmitted-list">${tasks.map(t=>`<li>${t.icon||"üìå"} ${t.title||t.content}</li>`).join("")}</ul></div>` 
    }

    function renderWidgets(widgets) {
        const container = document.getElementById('widgets-container');
        if(!widgets||widgets.length===0)return void(container.style.display="none");
        container.style.display="flex";
        container.innerHTML=widgets.map(t=>{let e="";switch(t.type){case"ÎîîÎç∞Ïù¥":const n=new Date;n.setHours(0,0,0,0);const o=new Date(t.content);o.setHours(0,0,0,0);const i=Math.ceil((o-n)/864e5);e=0===i?"D-Day":i>0?`D-${i}`:`D+${-i}`;break;case"Í∏âÏãù":e=`<div class="widget-content small-text">${t.content.replace(/\n/g,"<br>")}</div>`;break;case"ÎßÅÌÅ¨":e=`<a href="${t.content}" target="_blank" style="font-size: 1.2em;">Î∞îÎ°úÍ∞ÄÍ∏∞</a>`;break;default:e=t.content}return`<div class="widget"><div class="widget-title">${t.title}</div>${"Í∏âÏãù"!==t.type?`<div class="widget-content">${e}</div>`:e}</div>`}).join("");
    }
    
    function renderResources(resources) {
        const container = document.getElementById('resources');
        if (!resources || resources.length === 0) { container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Îì±Î°ùÎêú ÏûêÎ£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>'; return; }
        container.innerHTML = resources.map(res => `<a href="${res.link}" target="_blank" class="resource-card"><div class="resource-title">${res.icon || 'üîó'} ${res.title}</div><p>${res.description||"¬†"}</p></a>`).join('');
    }

    function renderLeaveRequests(requests) {
        const container = document.getElementById('leave-requests');
        if (!requests || requests.length === 0) { container.innerHTML = '<div class="empty-state">Ïã†Ï≤≠ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>'; return; }
        const todayStr = new Date().toISOString().split('T')[0];
        container.innerHTML = requests.map(req => {
            const statusMap = { 'Ïã†Ï≤≠': 'status-pending', 'ÏäπÏù∏': 'status-approved', 'Î∞òÎ†§': 'status-rejected' };
            const statusClass = statusMap[req.ÏÉÅÌÉú] || '';
            const commentHtml = req.ÍµêÏÇ¨ÏΩîÎ©òÌä∏ ? `<div class="leave-comment"><strong>ÍµêÏÇ¨ ÏùòÍ≤¨:</strong> ${req.ÍµêÏÇ¨ÏΩîÎ©òÌä∏}</div>` : '';
            const requestDate = new Date(req.Ìù¨ÎßùÏùºÏûê).toISOString().split('T')[0];
            const certificateButton = (req.ÏÉÅÌÉú === 'ÏäπÏù∏' && requestDate === todayStr) ? `<a href="${SCRIPT_URL}?action=getCertificate&rowNum=${req.Ïã†Ï≤≠ÌñâÎ≤àÌò∏}" target="_blank" class="certificate-link">ÌôïÏù∏Ï¶ù Ï∂úÎ†•</a>` : '';
            return `<div class="notice-item"><div class="leave-history-item"><div><strong>${req.Ïã†Ï≤≠Ï¢ÖÎ•ò}</strong> (${new Date(req.Ìù¨ÎßùÏùºÏûê).toLocaleDateString()})<br><small>ÏÇ¨Ïú†: ${req.ÏÇ¨Ïú†}</small></div><div><span class="leave-status ${statusClass}">${req.ÏÉÅÌÉú}</span>${certificateButton}</div></div>${commentHtml}</div>`;
        }).join('');
    }

    async function submitLeaveRequest() {
        if (!currentUser || !currentUser.studentId) { alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïã†Ï≤≠Ìï† Ïàò ÏûàÏäµÎãàÎã§."); return; }
        const form = document.getElementById('leave-request-form');
        if (!form.checkValidity()) { alert('Î™®Îì† ÌïÑÎìúÎ•º Ï±ÑÏõåÏ£ºÏÑ∏Ïöî.'); return; }
        const formData = new FormData(form);
        const params = new URLSearchParams({
            action: 'submitLeaveRequest', studentId: currentUser.studentId, name: currentUser.name, email: currentUser.email,
            type: formData.get('type'), reason: formData.get('reason'), date: formData.get('date')
        });
        document.getElementById('submitLeave').disabled = true;
        try {
            const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await response.json();
            alert(result.message);
            if (result.status === 'success') {
                document.getElementById('modal-overlay').style.display = 'none';
                form.reset();
                loadData();
            }
        } catch (error) { alert('Ïã†Ï≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
        } finally { document.getElementById('submitLeave').disabled = false; }
    }
    
    function renderTeacherDashboard(data) {
        document.getElementById('teacher-admin-section').innerHTML = `<div class="section"><div class="section-title"><span class="icon">‚öôÔ∏è</span>Í¥ÄÎ¶¨Ïûê ÎèÑÍµ¨</div><div class="teacher-dashboard-grid"><a href="${data.sheetUrl}" target="_blank" class="teacher-card"><div class="teacher-card-title">üìä Îç∞Ïù¥ÌÑ∞ ÏãúÌä∏ ÏàòÏ†ï</div><p>ÏïåÎ¶º, ÏúÑÏ†Ø, ÏûêÎ£åÏã§ Îì± Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏàòÏ†ïÌï©ÎãàÎã§.</p></a><div class="teacher-card form-creator"><input type="text" id="new-form-title" placeholder="ÏÉà Íµ¨Í∏ÄÌèº Í≥ºÏ†ú Ï†úÎ™©"><button onclick="createFormAssignment(event)">ÏÉùÏÑ±</button></div></div></div>`;
        
        const routineContainer = document.getElementById('routine-tasks-section');
        const today = new Date();
        const dayOfWeek = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'][today.getDay()];
        const todayRoutines = data.routines.filter(r => {
            if (!r.condition) return false;
            const conditions = r.condition.split(',').map(s=>s.trim());
            if (conditions.includes('Îß§Ïùº')) return true;
            if (conditions.includes('Ï£ºÏ§ë') && (dayOfWeek !== 'ÌÜ†' && dayOfWeek !== 'Ïùº')) return true;
            if (conditions.includes('Ï£ºÎßê') && (dayOfWeek === 'ÌÜ†' || dayOfWeek === 'Ïùº')) return true;
            return conditions.includes(dayOfWeek);
        });

        if (todayRoutines.length > 0) {
            routineContainer.style.display = 'block';
            routineContainer.innerHTML = `<div class="section-title"><span class="icon">üåü</span>Ïò§ÎäòÏùò Î£®Ìã¥ ÏóÖÎ¨¥</div>` + 
            todayRoutines.map(r => `
                <div class="routine-item ${completedItems[r.id] ? 'completed' : ''}" id="${r.id}">
                    <input type="checkbox" id="check-${r.id}" onchange="toggleRoutineComplete('${r.id}')" ${completedItems[r.id] ? 'checked' : ''}>
                    <label for="check-${r.id}">${r.title}</label>
                </div>
            `).join('');
        } else { routineContainer.style.display = 'none'; }
        
        const assignmentContainer = document.getElementById('assignment-status');
        if(data.assignments && data.assignments.length > 0){
            assignmentContainer.parentElement.style.display = 'block';
            assignmentContainer.innerHTML = data.assignments.map(a => `<div class="assignment-card" id="${a.id}"><button class="teacher-complete-btn" title="Î™©Î°ùÏóêÏÑú Ïà®Í∏∞Í∏∞" onclick="completeItem('${a.id}', true, ${a.rowNum}, '[Îç∞Ïù¥ÌÑ∞_ÏïåÎ¶º]')">‚úñ</button><div class="notice-title">${a.title}</div><div class="assignment-actions">${a.responseSheetUrl ? `<a href="${a.responseSheetUrl}" target="_blank"><button class="response-btn">ÏùëÎãµ ÌôïÏù∏</button></a>` : ''}${(a.assignmentType === 'Îã®ÏùºÏ†úÏ∂ú') ? `<button class="check-btn" onclick="checkUnsubmitted(event, '${a.taskId}', '${a.title}', '${a.studentIdColumn}')">ÎØ∏Ï†úÏ∂úÏûê ÌôïÏù∏</button>` : ''}</div></div>`).join('');
        } else {
            assignmentContainer.parentElement.style.display = 'none';
        }

        const linksContainer = document.getElementById('teacher-links');
        const groupedItems = data.dashboardItems.reduce((acc, item) => {
            (acc[item.type] = acc[item.type] || []).push(item);
            return acc;
        }, {});
        
        linksContainer.innerHTML = Object.keys(groupedItems).map(group => {
            return `<div class="section">
                        <div class="section-title"><span class="icon">üóÇÔ∏è</span>${group}</div>
                        <div class="teacher-dashboard-grid">
                            ${groupedItems[group].map(item => `
                                <a href="${item.url || '#'}" target="_blank" class="teacher-card">
                                    <div class="teacher-card-title">${item.title}</div>
                                    <p>${item.description || '¬†'}</p>
                                </a>`).join('')}
                        </div>
                    </div>`;
        }).join('');

        const pendingContainer = document.getElementById('pending-leave-requests');
        if (!data.pendingLeaveRequests || data.pendingLeaveRequests.length === 0) {
            pendingContainer.parentElement.style.display = 'none';
        } else {
            pendingContainer.parentElement.style.display = 'block';
            pendingContainer.innerHTML = data.pendingLeaveRequests.map(req => `<div class="teacher-leave-card"><strong>${req.Ïù¥Î¶Ñ} (${req.ÌïôÎ≤à})</strong> - ${req.Ïã†Ï≤≠Ï¢ÖÎ•ò} (${new Date(req.Ìù¨ÎßùÏùºÏûê).toLocaleDateString()})<p>ÏÇ¨Ïú†: ${req.ÏÇ¨Ïú†}</p><input type="text" id="comment-${req.rowNum}" class="leave-comment-input" placeholder="ÏΩîÎ©òÌä∏ (ÏÑ†ÌÉù ÏÇ¨Ìï≠)"><div class="leave-actions"><button class="approve-btn" onclick="updateLeaveStatus(${req.rowNum}, 'ÏäπÏù∏', 'comment-${req.rowNum}')">ÏäπÏù∏</button><button class="reject-btn" onclick="updateLeaveStatus(${req.rowNum}, 'Î∞òÎ†§', 'comment-${req.rowNum}')">Î∞òÎ†§</button></div></div>`).join('');
        }
    }

    function toggleRoutineComplete(itemId) {
        const checkbox = document.getElementById(`check-${itemId}`);
        const itemElement = document.getElementById(itemId);
        if (checkbox.checked) { completedItems[itemId] = true; } 
        else { delete completedItems[itemId]; }
        saveCompletedItems();
        itemElement.classList.toggle('completed', checkbox.checked);
    }
    
    async function checkUnsubmitted(event, taskId, taskTitle, studentIdColumn) {
        const button = event.target; button.disabled = true;
        const params = new URLSearchParams({ action: 'getUnsubmittedStudents', taskId: taskId, studentIdColumn: studentIdColumn });
        try {
            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();
            if (result.status !== 'success') throw new Error(result.message);
            let message = `[${taskTitle}] ÎØ∏Ï†úÏ∂ú ÌïôÏÉù:\n\n`;
            if (result.students.length === 0) { message = `[${taskTitle}]\n\nÎ™®Îì† ÌïôÏÉùÏù¥ Ï†úÏ∂úÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§!`; } 
            else { message += result.students.map(s => `${s.name} (${s.id})`).join('\n'); }
            alert(message);
        } catch (error) { alert('ÎØ∏Ï†úÏ∂úÏûê ÌôïÏù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + error.message);
        } finally { button.disabled = false; }
    }

    async function updateLeaveStatus(rowNum, status, commentInputId) {
        const commentEl = document.getElementById(commentInputId);
        const comment = commentEl ? commentEl.value : '';
        const params = new URLSearchParams({ action: 'updateLeaveStatus', rowNum, status, comment: comment });
        try {
            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();
            if (result.status === 'success') { alert(`${status} Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.`); loadData(); } 
            else { throw new Error(result.message); }
        } catch (error) { alert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + error.message); }
    }
    
    async function createFormAssignment(event) {
        const title = document.getElementById('new-form-title').value;
        if (!title) { alert('Í≥ºÏ†ú Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
        const button = event.target; button.disabled = true; button.textContent = 'ÏÉùÏÑ± Ï§ë...';
        const params = new URLSearchParams({ action: 'createFormAssignment', title: title });
        try {
            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();
            if (result.status === 'success') {
                alert(result.message);
                document.getElementById('new-form-title').value = '';
                loadData();
            } else { throw new Error(result.message); }
        } catch(error) { alert('Ìèº ÏÉùÏÑ± Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + error.message);
        } finally { button.disabled = false; button.textContent = 'ÏÉùÏÑ±'; }
    }
    
    function updateDateDisplay() {
        document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
    }
</script>
</html>
