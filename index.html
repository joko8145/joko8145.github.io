    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz9uD_erKui2gbXrunA-ub2r61_NaLHK75TnhHxAQewsjoGsvyzVeWL_NJ9z9lophzF/exec';
    const GOOGLE_CLIENT_ID = '190435721099-45et34v9elbvod5lb84ddakrnenh5039.apps.googleusercontent.com';

    let currentUser = null;
    let submittedTasks = new Set();
    let completedItems = {}; // 개인화 완료 항목 저장 객체
    const urlParams = new URLSearchParams(window.location.search);
    const isTeacherMode = urlParams.get('mode') === 'teacher';

    window.onload = function () {
        loadCompletedItems();
        google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
        const storedUser = localStorage.getItem('userInfo');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            renderUserInfo(currentUser);
            loadData();
        } else {
            google.accounts.id.renderButton(document.getElementById("gsi-container"), { theme: "outline", size: "large", text: "signin_with", shape: "pill" });
            if (!isTeacherMode) {
                loadData();
            } else {
                document.getElementById('teacher-dashboard').style.display = 'block';
                document.getElementById('student-portal').style.display = 'none';
                document.getElementById('teacher-dashboard').innerHTML = '<div class="empty-state">교사 계정으로 로그인해주세요.</div>';
            }
        }
        updateDateDisplay();
        setupEventListeners();
    };
    
    function loadCompletedItems() {
        const todayStr = new Date().toISOString().split('T')[0];
        const storedData = localStorage.getItem('completedItems');
        if (storedData) {
            const data = JSON.parse(storedData);
            if (data.date === todayStr) {
                completedItems = data.items || {};
            } else {
                localStorage.removeItem('completedItems');
            }
        }
    }

    function saveCompletedItems() {
        const todayStr = new Date().toISOString().split('T')[0];
        localStorage.setItem('completedItems', JSON.stringify({
            date: todayStr,
            items: completedItems
        }));
    }

    function setupEventListeners() {
        const goOutBtn = document.getElementById('request-go-out');
        if (goOutBtn) goOutBtn.addEventListener('click', () => openLeaveModal('외출'));
        
        const earlyLeaveBtn = document.getElementById('request-early-leave');
        if(earlyLeaveBtn) earlyLeaveBtn.addEventListener('click', () => openLeaveModal('조퇴'));

        const closeModalBtn = document.getElementById('closeModal');
        if(closeModalBtn) closeModalBtn.addEventListener('click', () => document.getElementById('modal-overlay').style.display = 'none');

        const submitLeaveBtn = document.getElementById('submitLeave');
        if(submitLeaveBtn) submitLeaveBtn.addEventListener('click', submitLeaveRequest);
    }

    function openLeaveModal(type) {
        document.getElementById('modal-title').textContent = `${type} 신청`;
        document.getElementById('leave-type').value = type;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('leave-date').value = today;
        document.getElementById('leave-reason').value = '';
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    
    async function handleCredentialResponse(response) {
        const userObject = JSON.parse(atob(response.credential.split('.')[1]));
        currentUser = { name: userObject.name, email: userObject.email, picture: userObject.picture, studentId: null, isTeacher: false };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        location.reload();
    }

    function handleLogout() {
        localStorage.removeItem('userInfo');
        currentUser = null;
        google.accounts.id.disableAutoSelect();
        location.reload();
    }

    function renderUserInfo(user) {
        const displayEl = document.getElementById('user-display');
        const gsiContainer = document.getElementById('gsi-container');
        if(!displayEl || !gsiContainer) return;
        displayEl.style.display = 'block';
        gsiContainer.style.display = 'none';
        let userInfoHtml = `<span class="user-info"><img src="${user.picture}" alt="profile"><strong>${user.name}</strong>님 <a href="#" onclick="handleLogout()">로그아웃</a></span>`;
        if (user.studentId === null && !user.isTeacher) {
            userInfoHtml += ` <span class="user-info" style="color: #ffc107;">(미등록)</span>`;
        }
        displayEl.innerHTML = userInfoHtml;
    }

    async function loadData() {
        let fullUrl = `${SCRIPT_URL}?v=${new Date().getTime()}`;
        if (isTeacherMode) {
            document.getElementById('portal-title').textContent = '🎓 교사 통합 대시보드';
            fullUrl += '&mode=teacher';
        }
        if (currentUser) {
            fullUrl += `&email=${encodeURIComponent(currentUser.email)}`;
        }

        const studentPortal = document.getElementById('student-portal');
        const teacherDashboard = document.getElementById('teacher-dashboard');

        if (isTeacherMode) {
            studentPortal.style.display = 'none';
            teacherDashboard.style.display = 'block';
            document.getElementById('teacher-admin-section').innerHTML = '';
            document.getElementById('assignment-status').innerHTML = '<div class="empty-state">🔄 데이터를 불러오는 중...</div>';
            document.getElementById('pending-leave-requests').innerHTML = '<div class="empty-state">🔄 데이터를 불러오는 중...</div>';
            document.getElementById('teacher-links').innerHTML = '<div class="empty-state">🔄 데이터를 불러오는 중...</div>';
        } else {
            studentPortal.style.display = 'block';
            teacherDashboard.style.display = 'none';
            ['notices', 'tasks', 'resources', 'leave-requests'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '<div class="empty-state">🔄 데이터를 불러오는 중...</div>';
            });
        }
        
        try {
            const response = await fetch(fullUrl);
            if (!response.ok) throw new Error('데이터 로드 실패');
            const data = await response.json();
            
            if (data.error) {
                if (isTeacherMode) teacherDashboard.innerHTML = `<div class="empty-state">❌ ${data.error}</div>`;
                else studentPortal.innerHTML = `<div class="empty-state">❌ ${data.error}</div>`;
                if(data.user) { currentUser.name = data.user.name; renderUserInfo(currentUser); }
                return;
            }

            currentUser = { ...currentUser, ...data.user };
            localStorage.setItem('userInfo', JSON.stringify(currentUser));
            renderUserInfo(currentUser);

            if (isTeacherMode) {
                renderTeacherDashboard(data);
            } else {
                if (data.user && data.user.studentId) {
                    document.getElementById('leave-section').style.display = 'block';
                } else {
                    document.getElementById('leave-section').style.display = 'none';
                }
                
                submittedTasks = new Set(data.submittedTasks || []);
                renderItems('notices', data.notices.filter(item => !completedItems[item.id]), '자세히 보기 →');
                renderItems('tasks', data.tasks.filter(item => !completedItems[item.id]), '바로 하기 →', true);
                renderUnsubmitted(data.unsubmitted);
                renderResources(data.resources);
                renderLeaveRequests(data.leaveRequests);
            }

        } catch (error) {
            console.error('Error fetching data:', error);
            const targetEl = isTeacherMode ? teacherDashboard : document.getElementById('notices');
            targetEl.innerHTML = `<div class="empty-state">❌ 데이터 로드 실패! (${error.message})</div>`;
        }
    }
    
    async function completeItem(itemId, isTeacherAction = false, rowNum, sheetName) {
        const itemElement = document.getElementById(itemId);
        if (!itemElement) return;

        if (isTeacherAction) {
            const colName = (sheetName === '[데이터_알림]') ? '게시여부' : '상태';
            const value = (sheetName === '[데이터_알림]') ? 'N' : '완료';
            const params = new URLSearchParams({ action: 'updateTaskStatus', sheetName, rowNum, colName, value });
            try {
                const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
                const result = await res.json();
                if (result.status !== 'success') throw new Error(result.message);
            } catch (err) {
                alert(`항목 완료 처리 중 오류: ${err.message}`);
                return;
            }
        } else {
            completedItems[itemId] = true;
            saveCompletedItems();
        }

        itemElement.style.transition = 'opacity 0.5s, transform 0.5s';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateX(-50px)';
        setTimeout(() => itemElement.remove(), 500);
    }

    async function handleSubmission(item) {
        if (!currentUser || !currentUser.studentId) return; 
        if (submittedTasks.has(item.taskId)) return; 
        const params = new URLSearchParams({ action: 'logClick', studentId: currentUser.studentId, name: encodeURIComponent(currentUser.name), taskId: encodeURIComponent(item.taskId) });
        try {
            const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await response.json();
            if (result.status === 'success') {
                submittedTasks.add(item.taskId);
            }
        } catch (error) { console.error('제출 기록 오류:', error); }
    }

    function renderItems(containerId, items, defaultButtonText, isTask = false) {
        const container = document.getElementById(containerId);
        if (!items || items.length === 0) {
            container.innerHTML = `<div class="empty-state">${containerId === 'notices' ? '📝 오늘 등록된 공지사항이 없습니다.' : '✅ 오늘 할 일이 모두 완료되었습니다!'}</div>`;
            return;
        }
        container.innerHTML = items.map(item => {
            let completeButton = '';
            if (item.type !== '공지' && currentUser && currentUser.studentId) { // 학생은 공지 완료 불가
                 completeButton = `<button class="complete-btn" title="확인/완료" onclick="completeItem('${item.id}')">✔</button>`;
            }
            if (isTeacherMode) { // 교사는 모든 항목을 게시 종료 가능
                completeButton = `<button class="teacher-complete-btn" title="게시 종료" onclick="completeItem('${item.id}', true, ${item.rowNum}, '[데이터_알림]')">✖</button>`;
            }

            const icon = item.icon ? `<span class="icon">${item.icon}</span> ` : '';
            const title = item.title ? `<div class="notice-title">${icon}${item.title}</div>` : '';
            let contentHtml = '';
            
            const isChecklist = isTask && (item.type === '체크리스트' || (!item.link && item.content.includes(',')));

            if (isChecklist && item.taskId) {
                const subtasks = item.content.split(',').map(s => s.trim());
                contentHtml = `<ul class="subtask-list">` + subtasks.map(subtask => {
                    const fullTaskId = `${item.taskId}_${subtask}`;
                    const isCompleted = submittedTasks.has(fullTaskId);
                    return `<li class="subtask-item ${isCompleted ? 'completed' : ''}"><input type="checkbox" class="subtask-checkbox" onchange="toggleSubtask(this, '${item.taskId}', '${subtask}')" ${isCompleted ? 'checked' : ''}><label class="subtask-label">${subtask}</label></li>`;
                }).join('') + `</ul>`;
            } else {
                const image = item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.title || '알림 이미지'}" class="notice-image">` : '';
                const content = item.content ? `<div class="notice-content">${!title && !image ? icon : ''}${item.content.replace(/\n/g, '<br>')}</div>` : '';
                let finalLink = item.link;

                if (isTask && finalLink && finalLink.includes('__STUDENT_ID__')) {
                    if (currentUser && currentUser.studentId) {
                        finalLink = finalLink.replace('__STUDENT_ID__', currentUser.studentId).replace('__STUDENT_NAME__', encodeURIComponent(currentUser.name));
                    } else { finalLink = null; }
                }
                
                let linkHtml = '';
                if (finalLink) {
                    const clickHandler = item.recordable ? `onclick="handleSubmission({taskId: '${item.taskId}'})"` : '';
                    linkHtml = `<a href="${finalLink}" class="notice-link" target="_blank" ${clickHandler}>${item.buttonText || defaultButtonText}</a>`;
                }
                contentHtml = image + content + linkHtml;
            }
            return `<div class="notice-item" id="${item.id}">${completeButton}${title}${contentHtml}</div>`;
        }).join('');
    }

    async function toggleSubtask(checkbox, taskId, subtask) {
        if (!currentUser || !currentUser.studentId) { alert("로그인 후 이용해주세요."); checkbox.checked = !checkbox.checked; return; }
        const isChecked = checkbox.checked;
        const listItem = checkbox.closest('.subtask-item');
        listItem.style.opacity = '0.5';
        const params = new URLSearchParams({ action: 'logSubtask', studentId: currentUser.studentId, name: currentUser.name, taskId: taskId, subtask: subtask, isChecked: isChecked });
        try {
            const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            listItem.classList.toggle('completed', isChecked);
            const fullTaskId = `${taskId}_${subtask}`;
            if (isChecked) submittedTasks.add(fullTaskId); else submittedTasks.delete(fullTaskId);
        } catch (error) {
            alert(`오류: ${error.message}`); checkbox.checked = !isChecked;
        } finally { listItem.style.opacity = '1'; }
    }
    
    function renderUnsubmitted(tasks) { /* ... 이전과 동일 ... */ }
    function renderWidgets(widgets) { /* ... 이전과 동일 ... */ }
    function renderResources(resources) { /* ... 이전과 동일 ... */ }
    function renderLeaveRequests(requests) { /* ... 이전과 동일 ... */ }
    async function submitLeaveRequest() { /* ... 이전과 동일 ... */ }
    
    function renderTeacherDashboard(data) {
        const adminSection = document.getElementById('teacher-admin-section');
        adminSection.innerHTML = `<div class="section"><div class="section-title"><span class="icon">⚙️</span>관리자 도구</div><div class="teacher-dashboard-grid"><a href="${data.sheetUrl}" target="_blank" class="teacher-card"><div class="teacher-card-title">📊 데이터 시트 수정</div><p>알림, 위젯, 자료실 등 모든 데이터를 수정합니다.</p></a><div class="teacher-card form-creator"><input type="text" id="new-form-title" placeholder="새 구글폼 과제 제목"><button onclick="createFormAssignment(event)">생성</button></div></div></div>`;
        
        const routineContainer = document.getElementById('routine-tasks-section');
        const today = new Date();
        const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][today.getDay()];
        const todayRoutines = data.routines.filter(r => {
            if (!r.condition) return false;
            const conditions = r.condition.split(',').map(s=>s.trim());
            if (conditions.includes('주중') && (dayOfWeek === '토' || dayOfWeek === '일')) return false;
            if (conditions.includes('주말') && !(dayOfWeek === '토' || dayOfWeek === '일')) return false;
            if (conditions.includes('매일')) return true;
            return conditions.includes(dayOfWeek);
        });

        if (todayRoutines.length > 0) {
            routineContainer.innerHTML = `<div class="section-title"><span class="icon">🌟</span>오늘의 루틴 업무</div>` + 
            todayRoutines.map(r => `
                <div class="routine-item ${completedItems[r.id] ? 'completed' : ''}" id="${r.id}">
                    <input type="checkbox" id="check-${r.id}" onchange="toggleRoutineComplete('${r.id}')" ${completedItems[r.id] ? 'checked' : ''}>
                    <label for="check-${r.id}">${r.title}</label>
                </div>
            `).join('');
        } else {
            routineContainer.innerHTML = '';
        }

        const assignmentContainer = document.getElementById('assignment-status');
        if(data.assignments && data.assignments.length > 0){
            assignmentContainer.innerHTML = data.assignments.map(a => {
                const checkButton = (a.assignmentType === '단일제출') 
                    ? `<button class="check-btn" onclick="checkUnsubmitted(event, '${a.taskId}', '${a.title}', '${a.studentIdColumn}')">미제출자 확인</button>`
                    : '';
                const responseButton = a.responseSheetUrl ? `<a href="${a.responseSheetUrl}" target="_blank"><button class="response-btn">응답 확인</button></a>` : '';
                const completeButton = `<button class="teacher-complete-btn" title="목록에서 숨기기" onclick="completeItem('${a.id}', true, ${a.rowNum}, '[데이터_알림]')">✖</button>`;

                return `<div class="assignment-card" id="${a.id}">
                            ${completeButton}
                            <div class="notice-title">${a.title}</div>
                            <div class="assignment-actions">
                                ${responseButton}
                                ${checkButton}
                            </div>
                        </div>`
            }).join('');
        } else {
            assignmentContainer.innerHTML = '<div class="empty-state">확인할 과제가 없습니다.</div>';
        }

        const tabsContainer = document.getElementById('teacher-tabs-container');
        const linksContainer = document.getElementById('teacher-links');
        const tabs = Object.keys(data.dashboardItems);
        tabsContainer.innerHTML = tabs.map(tab => `<button class="tab-btn" onclick="filterTeacherTasks('${tab}')">${tab}</button>`).join('');
        
        window.filterTeacherTasks = (selectedTab) => {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            linksContainer.innerHTML = `<div class="teacher-dashboard-grid">` + 
            data.dashboardItems[selectedTab].map(item => `
                <div class="teacher-card" id="${item.id}">
                    <button class="teacher-complete-btn" title="완료 처리" onclick="completeItem('${item.id}', true, ${item.rowNum}, '[교사_대시보드]')">✔</button>
                    <div class="teacher-card-title">${item.title}</div>
                    <p>${item.description}</p>
                    ${item.url ? `<a href="${item.url}" target="_blank" class="teacher-card-button">${item.buttonText || '바로가기'}</a>` : ''}
                </div>
            `).join('') + `</div>`;
        };

        if (tabs.length > 0) {
            document.querySelector('.tab-btn').click(); // 첫 번째 탭을 기본으로 활성화
        } else {
            linksContainer.innerHTML = '<div class="empty-state">등록된 관리 시스템이 없습니다.</div>';
        }

        const pendingContainer = document.getElementById('pending-leave-requests');
        if (!data.pendingLeaveRequests || data.pendingLeaveRequests.length === 0) {
            pendingContainer.innerHTML = '<div class="empty-state">확인 대기 중인 신청이 없습니다.</div>';
        } else {
            pendingContainer.innerHTML = data.pendingLeaveRequests.map(req => `<div class="teacher-leave-card"><strong>${req.이름} (${req.학번})</strong> - ${req.신청종류} (${new Date(req.희망일자).toLocaleDateString()})<p>사유: ${req.사유}</p><input type="text" id="comment-${req.rowNum}" class="leave-comment-input" placeholder="코멘트 (선택 사항)"><div class="leave-actions"><button class="approve-btn" onclick="updateLeaveStatus(${req.rowNum}, '승인', 'comment-${req.rowNum}')">승인</button><button class="reject-btn" onclick="updateLeaveStatus(${req.rowNum}, '반려', 'comment-${req.rowNum}')">반려</button></div></div>`).join('');
        }
    }

    function toggleRoutineComplete(itemId) {
        const checkbox = document.getElementById(`check-${itemId}`);
        const itemElement = document.getElementById(itemId);
        if (checkbox.checked) {
            completedItems[itemId] = true;
        } else {
            delete completedItems[itemId];
        }
        saveCompletedItems();
        itemElement.classList.toggle('completed', checkbox.checked);
    }
    
    async function checkUnsubmitted(event, taskId, taskTitle, studentIdColumn) {
        const button = event.target; button.disabled = true;
        const params = new URLSearchParams({ action: 'getUnsubmittedStudents', taskId: taskId, studentIdColumn: studentIdColumn });
        try {
            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();
            if (result.status !== 'success') throw new Error(result.message);
            let message = `[${taskTitle}] 미제출 학생:\n\n`;
            if (result.students.length === 0) {
                message = `[${taskTitle}]\n\n모든 학생이 제출을 완료했습니다!`;
            } else {
                message += result.students.map(s => `${s.name} (${s.id})`).join('\n');
            }
            alert(message);
        } catch (error) { alert('미제출자 확인 중 오류 발생: ' + error.message);
        } finally { button.disabled = false; }
    }

    async function updateLeaveStatus(rowNum, status, commentInputId) {
        const commentEl = document.getElementById(commentInputId);
        const comment = commentEl ? commentEl.value : '';
        const params = new URLSearchParams({ action: 'updateLeaveStatus', rowNum, status, comment: comment });
        try {
            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();
            if (result.status === 'success') { alert(`${status} 처리되었습니다.`); loadData(); } 
            else { throw new Error(result.message); }
        } catch (error) { alert('처리 중 오류 발생: ' + error.message); }
    }
    
    async function createFormAssignment(event) {
        const title = document.getElementById('new-form-title').value;
        if (!title) { alert('과제 제목을 입력해주세요.'); return; }
        const button = event.target; button.disabled = true; button.textContent = '생성 중...';
        const params = new URLSearchParams({ action: 'createFormAssignment', title: title });
        try {
            const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await res.json();
            if (result.status === 'success') {
                alert(result.message);
                document.getElementById('new-form-title').value = '';
                loadData();
            } else { throw new Error(result.message); }
        } catch(error) { alert('폼 생성 중 오류 발생: ' + error.message);
        } finally { button.disabled = false; button.textContent = '생성'; }
    }
    
    function updateDateDisplay() {
        document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
    }

</script>
</html>
