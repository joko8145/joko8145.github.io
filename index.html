<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïä§ÎßàÌä∏ ÌïôÍ∏â Í¥ÄÎ¶¨ ÌîåÎû´Ìèº</title>
    <link rel="icon" type="image/png" href="/portal-dev/favicon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* [ÏÉà UI ÎîîÏûêÏù∏ CSS] */
        :root {
            --primary-color: #5D78E6;
            --secondary-color: #A25AF2;
            --light-bg: #f4f6fc;
            --white-bg: #ffffff;
            --text-dark: #212529;
            --text-light: #6c757d;
            --border-color: #e9ecef;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light-bg);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        /* Ìó§Îçî Ïä§ÌÉÄÏùº */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin: 0; font-weight: 700; } /* ÎÇ†ÏßúÍ∞Ä ÏóÜÏúºÎØÄÎ°ú margin-bottom Ï†úÍ±∞ */

        .content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            font-size: 1.1em;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        .card {
            background: var(--white-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .card-title { font-size: 1.1em; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); }
        .card-description { font-size: 0.95em; color: var(--text-light); line-height: 1.6; }
        
        /* ÏúÑÏ†Ø */
        #widgets-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .widget { background-color: var(--white-bg); padding: 20px; text-align: center; border-radius: var(--border-radius); box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .widget-title { font-weight: 500; margin-bottom: 8px; color: var(--text-light); }
        .widget-content { font-size: 2.2em; font-weight: 700; color: var(--primary-color); }

        /* ÎØ∏Ï†úÏ∂ú Í≥ºÏ†ú */
        .unsubmitted-section { background-color: #fff9e6; border: 1px solid #ffe7ab; color: #8a6d3b; padding: 15px 20px; margin-bottom: 30px; border-radius: var(--border-radius); }
        .unsubmitted-section p { font-weight: 600; margin-bottom: 8px; }

        /* ÌïôÍ∏âÏùºÏ†ï & ÏûêÎ£åÏã§ Í∑∏Î¶¨Îìú */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }

        /* ÌÉ≠ Î©îÎâ¥ */
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; }
        .tab-button { padding: 12px 18px; cursor: pointer; border: none; background: none; font-size: 1em; font-weight: 500; color: var(--text-light); position: relative; transition: color 0.2s; }
        .tab-button.active { color: var(--primary-color); font-weight: 600; }
        .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--primary-color); border-radius: 3px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Í≥µÏßÄ & Ìï† Ïùº Ïπ¥Îìú */
        .notice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--primary-color);
        }
        .action-btn { padding: 8px 16px; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500; transition: background-color 0.2s; text-decoration: none; display: inline-block; margin-top: 12px; }
        .complete-btn { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 14px; border-radius: 20px; cursor: pointer; font-size: 0.9em; flex-shrink: 0; margin-left: 15px; }

        /* Ïô∏Ï∂ú/Ï°∞Ìá¥ Ìèº */
        .leave-form { background: #f8f9fa; padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
        .leave-type-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .leave-type-btn { background-color: #e9ecef; color: #495057; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
        .leave-type-btn.selected { background-color: var(--primary-color); color: white; font-weight: 600; }
        .form-actions { text-align: right; }
        .form-actions .action-btn { background-color: var(--primary-color); }
        .leave-history .card { display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 600; color: white; }
        .status-ÏäπÏù∏ { background-color: #28a745; }
        .status-Î∞òÎ†§ { background-color: #dc3545; }
        .status-Ïã†Ï≤≠ { background-color: #ffc107; }

    </style>
</head>
<body>
    <div class="container">
        <!-- ‚òÖ‚òÖ‚òÖ ÏàòÏ†ï: ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ÏôÄ ÎÇ†ÏßúÍ∞Ä ÏóÜÎäî ÍπîÎÅîÌïú Ìó§Îçî ‚òÖ‚òÖ‚òÖ -->
        <div class="header">
            <h1>üì¢ Ïò§ÎäòÏùò ÏïåÎ¶º</h1>
        </div>
        <div class="content">
            <div id="student-portal">
                <!-- ÌïôÏÉù Î∑∞Í∞Ä Ïù¥ ÏïàÏóê Î†åÎçîÎßÅÎê©ÎãàÎã§ -->
                <div class="empty-state">
                    <!-- Î°úÍ∑∏Ïù∏ Î≤ÑÌäºÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    <div id="gsi-container"></div>
                </div>
            </div>
            <div id="teacher-dashboard" style="display: none;">
                <!-- ÍµêÏÇ¨ Î∑∞Í∞Ä Ïù¥ ÏïàÏóê Î†åÎçîÎßÅÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

<script>
// [ÏµúÏ¢Ö UI Ïò§Î•ò ÏàòÏ†ï Ïä§ÌÅ¨Î¶ΩÌä∏ ÏΩîÎìú]

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgr1HhCTgNnbj1umxlhVPOavO-BCTJOCZN2AZgMtAXiwwCeZFYcsmLOA4-8rR7fCeE/exec';
const GOOGLE_CLIENT_ID = '209932065927-v6kg2bd8gmgfdrksaqrhb7lqo12j6vrf.apps.googleusercontent.com';

let currentUser = null;
let completedItems = {};
const urlParams = new URLSearchParams(window.location.search);
const isTeacherMode = urlParams.get('mode') === 'teacher';

window.onload = function() {
    try {
        currentUser = JSON.parse(localStorage.getItem('userInfo'));
    } catch (e) {
        localStorage.removeItem('userInfo');
        currentUser = null;
    }
    loadCompletedItems();
    // ‚òÖ‚òÖ‚òÖ ÏàòÏ†ï: updateDateDisplay() Ìï®Ïàò Ìò∏Ï∂ú ÏÇ≠Ï†ú ‚òÖ‚òÖ‚òÖ

    if (currentUser) {
        // renderUserInfo(currentUser); // loadData ÏïàÏóêÏÑú Ìò∏Ï∂úÎêòÎØÄÎ°ú Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        loadData();
    } else {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleCredentialResponse,
            ux_mode: 'redirect',
            login_uri: 'https://joko8145.github.io/portal-dev'
        });
        google.accounts.id.prompt((notification) => {
            if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                google.accounts.id.renderButton(document.getElementById('gsi-container'), { theme: 'outline', size: 'large' });
            }
        });
    }
    setupEventListeners();
};

function setupEventListeners() {
    document.body.addEventListener('click', function(e) {
        const target = e.target;

        if (target.closest('.tab-button')) {
            const button = target.closest('.tab-button');
            const targetPaneId = button.dataset.tab;
            const tabContainer = button.closest('.tabs');
            tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const contentContainer = tabContainer.nextElementSibling;
            if (contentContainer) {
                contentContainer.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');
                const targetPane = document.getElementById(targetPaneId);
                if (targetPane) targetPane.style.display = 'block';
            }
        }

        if (target.closest('.accordion-title')) {
            target.closest('.accordion-title').classList.toggle('active');
            const content = target.closest('.accordion-title').nextElementSibling;
            if (content) {
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        if (target.closest('#new-post-btn')) { document.getElementById('new-post-modal').style.display = 'flex'; }
        if (target.closest('.modal-close-btn')) { target.closest('.modal-overlay').style.display = 'none'; }
        if (target.closest('.leave-type-btn')) {
            document.querySelectorAll('.leave-type-btn').forEach(btn => btn.classList.remove('selected'));
            target.classList.add('selected');
        }
    });

    document.body.addEventListener('submit', function(e) {
        if (e.target.id === 'leave-request-form') { e.preventDefault(); submitLeaveRequest(e.target); }
        if (e.target.id === 'new-post-form') { e.preventDefault(); submitNewPost(e.target); }
    });
}

function loadCompletedItems() {
    const todayStr = new Date().toISOString().split('T')[0];
    const storedData = localStorage.getItem('completedItems');
    if (storedData) {
        try {
            const data = JSON.parse(storedData);
            if (data.date === todayStr) { completedItems = data.items || {}; } 
            else { localStorage.removeItem('completedItems'); completedItems = {}; }
        } catch (e) { localStorage.removeItem('completedItems'); completedItems = {}; }
    }
}

function saveCompletedItems() {
    localStorage.setItem('completedItems', JSON.stringify({ date: new Date().toISOString().split('T')[0], items: completedItems }));
}

async function handleCredentialResponse(response) {
    if (response && response.credential) {
        const userObject = JSON.parse(atob(response.credential.split('.')[1]));
        currentUser = { name: userObject.name, email: userObject.email, picture: userObject.picture };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        const cleanUrl = window.location.origin + window.location.pathname + (isTeacherMode ? '?mode=teacher' : '');
        window.location.href = cleanUrl;
    }
}

function handleLogout() {
    localStorage.clear();
    google.accounts.id.disableAutoSelect();
    location.reload();
}

// ‚òÖ‚òÖ‚òÖ ÏàòÏ†ï: updateDateDisplay() Ìï®Ïàò ÏôÑÏ†Ñ ÏÇ≠Ï†ú ‚òÖ‚òÖ‚òÖ

async function loadData() {
    const studentEl = document.getElementById('student-portal');
    const teacherEl = document.getElementById('teacher-dashboard');
    const targetEl = isTeacherMode ? teacherEl : studentEl;

    if (studentEl) studentEl.style.display = isTeacherMode ? 'none' : 'block';
    if (teacherEl) teacherEl.style.display = isTeacherMode ? 'block' : 'none';

    targetEl.innerHTML = '<div class="empty-state">üîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
    
    const fullUrl = `${SCRIPT_URL}?v=${new Date().getTime()}&email=${encodeURIComponent(currentUser.email)}` + (isTeacherMode ? '&mode=teacher' : '');
    try {
        const response = await fetch(fullUrl);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        currentUser = { ...currentUser, ...data.user };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        
        if (isTeacherMode) {
            renderTeacherDashboard(data);
        } else {
            renderStudentPortal(data);
        }
        
    } catch (error) {
        targetEl.innerHTML = `<div class="empty-state">‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}</div>`;
    }
}
    
function renderUserInfo(user) {
    const displayEl = document.getElementById('user-display');
    if (!displayEl) return;
    
    const gsiContainer = document.getElementById('gsi-container');
    if(gsiContainer) gsiContainer.style.display = 'none';

    displayEl.style.display = 'flex';
    
    let userInitial = '';
    const nameParts = (user.name || '').split('');
    if (nameParts.length > 1) {
        userInitial = nameParts[0] + nameParts[nameParts.length - 1];
    } else {
        userInitial = nameParts[0] || '';
    }

    const userProfileHtml = user.picture 
        ? `<img src="${user.picture}" class="user-profile-image" alt="profile">`
        : `<div class="user-initial">${userInitial}</div>`;

    displayEl.innerHTML = `<div class="user-display">${userProfileHtml}<div class="user-name-logout"><strong>${user.name}</strong><a href="#" onclick="handleLogout()">Î°úÍ∑∏ÏïÑÏõÉ</a></div></div>`;
}

// --- ÍµêÏÇ¨ ÎåÄÏãúÎ≥¥Îìú UIÎ•º Í∑∏Î¶¨Îäî Ìï®ÏàòÎì§ ---

function renderTeacherDashboard(data) {
    const dashboard = document.getElementById('teacher-dashboard');
    // ‚òÖ‚òÖ‚òÖ ÏàòÏ†ï: portal-title ÏàòÏ†ï ÏΩîÎìú ÏÇ≠Ï†ú ‚òÖ‚òÖ‚òÖ
    
    dashboard.innerHTML = `
        <div class="auth-container"><div id="user-display"></div></div>
        <div class="header">
            <h1>üíº ÏóÖÎ¨¥ ÎåÄÏãúÎ≥¥Îìú</h1>
            <div class="date-display">${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</div>
        </div>
        <div class="content">
            ${renderTeacherRoutines(data.routines)}
            ${renderClassManagement(data)}
            ${renderTeacherPersonalTasks(data.teacherPersonalTasks)}
            ${renderTeacherSettings(data)}
        </div>
    `;
    renderUserInfo(currentUser); // ÎåÄÏãúÎ≥¥ÎìúÍ∞Ä Í∑∏Î†§ÏßÑ ÌõÑ Ïú†Ï†Ä Ï†ïÎ≥¥ Î†åÎçîÎßÅ
}

function renderTeacherRoutines(routines) {
    if (!routines || routines.length === 0) return '';
    const routineHtml = routines.map(r => `
        <label class="routine-item ${completedItems[r.rowNum] ? 'completed' : ''}">
            <input type="checkbox" class="routine-checkbox" onchange="toggleRoutineComplete('${r.rowNum}', this)" ${completedItems[r.rowNum] ? 'checked' : ''}>
            <span>${r.ÏóÖÎ¨¥Î™Ö}</span>
        </label>
    `).join('');
    return `<div class="section"><h2 class="section-title">‚òÄÔ∏è Ïò§ÎäòÏùò Î£®Ìã¥ ÏóÖÎ¨¥</h2><div class="routine-tasks-container">${routineHtml}</div></div>`;
}

function renderClassManagement(data) {
    const allPosts = [...(data.allNotices || []), ...(data.allTasks || [])];
    return `<div class="section">
                <h2 class="section-title">üè† ÌïôÍ∏â Í¥ÄÎ¶¨</h2>
                <div class="accordion-item">
                    <div class="accordion-title">‚è∞ Ïô∏Ï∂ú/Ï°∞Ìá¥ Ïã†Ï≤≠ (${(data.pendingLeaveRequests || []).length}Í±¥)</div>
                    <div class="accordion-content" style="display:none;">${renderLeaveCards(data.pendingLeaveRequests)}</div>
                </div>
                <div class="accordion-item">
                    <div class="accordion-title">üìù Í≥ºÏ†úÎ≥Ñ Ï†úÏ∂ú ÌòÑÌô© (${(data.assignments || []).length}Í±¥)</div>
                    <div class="accordion-content" style="display:none;">${renderAssignmentCards(data.assignments)}</div>
                </div>
                <div class="accordion-item">
                    <div class="accordion-title">üì¢ ÏïåÎ¶º Ìè¨ÌÑ∏ Í≤åÏãú ÌòÑÌô© (${allPosts.length}Í±¥)</div>
                    <div class="accordion-content" style="display:none;">${renderPostStatusCards(allPosts)}</div>
                </div>
                <div class="accordion-item">
                    <div class="accordion-title">üìÖ Ï†ÑÏ≤¥ ÌïôÍ∏â ÏùºÏ†ï (${(data.classSchedules || []).length}Í±¥)</div>
                    <div class="accordion-content" style="display:none;">${renderScheduleCards(data.classSchedules)}</div>
                </div>
            </div>`;
}

function renderLeaveCards(leaves) {
    if (!leaves || leaves.length === 0) return '<div class="empty-state" style="padding: 20px;">Ïã†Ï≤≠ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>';
    return leaves.map(req => `<div class="teacher-leave-card">
        <div class="leave-header"><strong>${req.Ïù¥Î¶Ñ || ''}(${req.ÌïôÎ≤à || ''})</strong><small>${req.Ïã†Ï≤≠Ï¢ÖÎ•ò}(${new Date(req.Ìù¨ÎßùÏùºÏûê).toLocaleDateString()})</small></div>
        <textarea class="leave-reason-input">${req.ÏÇ¨Ïú† || ''}</textarea>
        <div class="leave-actions">
            <button class="action-btn approve-btn" onclick="updateLeaveStatus(${req.rowNum}, 'ÏäπÏù∏', this)">ÏäπÏù∏</button>
            <button class="action-btn reject-btn" onclick="updateLeaveStatus(${req.rowNum}, 'Î∞òÎ†§', this)">Î∞òÎ†§</button>
        </div>
    </div>`).join('');
}

function renderAssignmentCards(assignments) {
    if (!assignments || assignments.length === 0) return '<div class="empty-state" style="padding: 20px;">Í¥ÄÎ¶¨Ìï† Í≥ºÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    return assignments.map(a => `<div class="card">${a.title}</div>`).join('');
}

function renderPostStatusCards(posts) {
    if (!posts || posts.length === 0) return '<div class="empty-state" style="padding: 20px;">Í≤åÏãúÎêú ÏïåÎ¶º/Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
    const postListHtml = posts.sort((a,b) => b.rowNum - a.rowNum).map(item => `
        <div class="card post-status-card" data-title="${(item.Ï†úÎ™© || '').toLowerCase()}" data-status="${item.Í≤åÏãúÏó¨Î∂Ä}">
            <span>${item.Ï†úÎ™©}</span>
            <label class="toggle-switch">
                <input type="checkbox" onchange="updatePostStatus(this, ${item.rowNum})" ${item.Í≤åÏãúÏó¨Î∂Ä === 'Y' ? 'checked' : ''}>
                <span class="slider"></span>
            </label>
        </div>`).join('');
    
    return `<div class="post-filter-controls">
                <input type="search" class="post-search-input" placeholder="Ï†úÎ™©ÏúºÎ°ú Í≤ÄÏÉâ..." oninput="filterPosts(this)">
                <div class="post-filter-tabs">
                    <button class="post-filter-btn active" data-filter="all" onclick="filterPosts(this, 'all')">Ï†ÑÏ≤¥</button>
                    <button class="post-filter-btn" data-filter="Y" onclick="filterPosts(this, 'Y')">Í≤åÏãúÏ§ë</button>
                    <button class="post-filter-btn" data-filter="N" onclick="filterPosts(this, 'N')">Ïà®ÍπÄ</button>
                </div>
            </div>
            <div class="post-list-container">${postListHtml}</div>
            <div class="empty-state post-filter-empty" style="display:none; padding: 20px;">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>`;
}

function renderScheduleCards(schedules) {
    if (!schedules || schedules.length === 0) return '<div class="empty-state" style="padding: 20px;">Îì±Î°ùÎêú ÌïôÍ∏â ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
    return schedules.map(s => `<div class="card">${s.Ï†úÎ™©}</div>`).join('');
}

function renderTeacherPersonalTasks(tasks) {
    if (!tasks || tasks.length === 0) return '';
    let tasksHtml = tasks.map(task => `<div class="card">
        <div class="card-title">${task.ÎÇ¥Ïö©}</div>
        ${task.ÎßÅÌÅ¨ ? `<a href="${task.ÎßÅÌÅ¨}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">Î∞îÎ°úÍ∞ÄÍ∏∞</a>` : ''}
    </div>`).join('');
    return `<div class="section"><h2 class="section-title">üìã ÏóÖÎ¨¥ ÏùºÏßÄ</h2>${tasksHtml}</div>`;
}

function renderTeacherSettings(data) {
    const groupedItems = (data.dashboardItems || []).reduce((acc, item) => {
        const type = item.Ï¢ÖÎ•ò || 'Í∏∞ÌÉÄ';
        if (!acc[type]) acc[type] = [];
        acc[type].push(item);
        return acc;
    }, {});
    const tabs = Object.keys(groupedItems);
    const tabButtonsHtml = tabs.map((tab, i) => `<button class="tab-button ${i===0 ? 'active' : ''}" data-tab="teacher-tab-${i}">${tab}</button>`).join('');
    const tabPanesHtml = tabs.map((tab, i) => {
        const itemsHtml = groupedItems[tab].map(item => `<a href="${item.ÎßÅÌÅ¨}" target="_blank" class="card"><div class="card-title">${item.ÏóÖÎ¨¥Î™Ö}</div><p class="card-description">${item.ÏÉÅÏÑ∏ÎÇ¥Ïö© || ''}</p></a>`).join('');
        return `<div id="teacher-tab-${i}" class="tab-pane" style="display: ${i === 0 ? 'block' : 'none'};">${itemsHtml}</div>`;
    }).join('');

    return `<div class="section">
                <h2 class="section-title">‚öôÔ∏è ÏÑ§Ï†ï</h2>
                <div class="teacher-dashboard-grid">
                    <div id="new-post-btn" class="card" style="cursor:pointer; text-align:center; display:flex; align-items:center; justify-content:center;"><div class="card-title">‚ú® ÏÉà Í≤åÏãúÎ¨º/ÏóÖÎ¨¥ Îì±Î°ù</div></div>
                    <a href="${data.sheetUrl}" target="_blank" class="card" style="display:flex; align-items:center; justify-content:center;"><div class="card-title">üìä Îç∞Ïù¥ÌÑ∞ ÏãúÌä∏ ÏàòÏ†ï</div></a>
                </div>
                <div class="tabs">${tabButtonsHtml}</div>
                <div class="tab-content">${tabPanesHtml}</div>
            </div>`;
}

async function updateLeaveStatus(rowNum, status, button) {
    const reasonInput = button.closest('.teacher-leave-card').querySelector('.leave-reason-input');
    const modifiedReason = reasonInput ? reasonInput.value : '';
    const params = new URLSearchParams({ action: 'updateLeaveStatus', rowNum, status, modifiedReason });
    alert('Ï≤òÎ¶¨ Ï§ë...');
    try {
        const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await res.json();
        alert(result.message);
        if (result.status === 'success') loadData();
    } catch (error) { alert('Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò: ' + error.message); }
}

function toggleRoutineComplete(itemId, checkbox) {
    const label = checkbox.closest('.routine-item');
    if (checkbox.checked) {
        completedItems[itemId] = true;
        label.classList.add('completed');
    } else {
        delete completedItems[itemId];
        label.classList.remove('completed');
    }
    saveCompletedItems();
}

async function updatePostStatus(checkbox, rowNum) {
    const newStatus = checkbox.checked ? 'Y' : 'N';
    const card = checkbox.closest('.post-status-card');
    card.dataset.status = newStatus;
    card.style.opacity = '0.5';
    const params = new URLSearchParams({ action: 'updatePostStatus', rowNum, newStatus });
    try {
        const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
    } catch (error) {
        alert(`Ïò§Î•ò: ${error.message}`);
        checkbox.checked = !checkbox.checked;
        card.dataset.status = checkbox.checked ? 'Y' : 'N';
    } finally {
        card.style.opacity = '1';
    }
}

async function submitNewPost(form) {
    const formData = new FormData(form);
    const params = new URLSearchParams({ action: 'createNewPost', ...Object.fromEntries(formData.entries()) });
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.textContent = 'Îì±Î°ù Ï§ë...';
    submitButton.disabled = true;
    try {
        const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await response.json();
        if (result.status !== 'success') { throw new Error(result.message); }
        alert(result.message);
        document.getElementById('new-post-modal').style.display = 'none';
        form.reset();
        loadData();
    } catch (error) {
        alert('Ïò§Î•ò: ' + error.message);
    } finally {
        submitButton.textContent = 'Îì±Î°ùÌïòÍ∏∞';
        submitButton.disabled = false;
    }
}

function filterPosts(button, filter) {
    const container = button.closest('.accordion-content');
    container.querySelectorAll('.post-filter-btn').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    
    const searchTerm = container.querySelector('.post-search-input').value.toLowerCase();
    
    const allPosts = container.querySelectorAll('.post-status-card');
    let visibleCount = 0;
    allPosts.forEach(post => {
        const title = post.dataset.title || '';
        const status = post.dataset.status || '';
        const matchesSearch = title.includes(searchTerm);
        const matchesFilter = (filter === 'all' || status === filter);

        if (matchesSearch && matchesFilter) {
            post.style.display = 'flex';
            visibleCount++;
        } else {
            post.style.display = 'none';
        }
    });
    
    const emptyState = container.querySelector('.post-filter-empty');
    if (emptyState) {
        emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
    }
}

// --- ÌïôÏÉù Ìè¨ÌÑ∏ UIÎ•º Í∑∏Î¶¨Îäî Ìï®ÏàòÎì§ ---

function renderStudentPortal(data) {
    const portal = document.getElementById('student-portal');
    // ‚òÖ‚òÖ‚òÖ ÏàòÏ†ï: portal-title ÏàòÏ†ï ÏΩîÎìú ÏÇ≠Ï†ú ‚òÖ‚òÖ‚òÖ

    portal.innerHTML = `
        <div class="header">
            <h1>üì¢ Ïò§ÎäòÏùò ÏïåÎ¶º</h1>
            <div class="date-display">${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</div>
        </div>
        <div class="content">
            <div class="auth-container" style="justify-content: flex-end; padding: 10px 0;">
                <div id="user-display"></div>
            </div>
            ${renderWidgets(data.widgets)}
            ${renderUnsubmitted(data.unsubmitted)}
            ${renderStudentClassSchedules(data.classSchedules)}
            <div class="tabs">
                <button class="tab-button active" data-tab="main-pane">ÏïåÎ¶º & Ìï† Ïùº</button>
                <button class="tab-button" data-tab="leave-pane" style="display:none;">Ïô∏Ï∂ú/Ï°∞Ìá¥</button>
                <button class="tab-button" data-tab="resource-pane" style="display:none;">ÏûêÎ£åÏã§</button>
            </div>
            <div class="tab-content">
                <div id="main-pane" class="tab-pane active" style="display:block;">
                    ${renderItemsSection('notices', data.notices, 'üìå Ï§ëÏöî Í≥µÏßÄ')}
                    ${renderItemsSection('tasks', data.tasks, '‚úÖ Ïò§ÎäòÏùò Ìï† Ïùº')}
                </div>
                <div id="leave-pane" class="tab-pane" style="display:none;">${renderLeaveSection(data.leaveRequests)}</div>
                <div id="resource-pane" class="tab-pane" style="display:none;">${renderResources(data.resources)}</div>
            </div>
        </div>
    `;

    if (data.user?.studentId) portal.querySelector('[data-tab="leave-pane"]').style.display = 'inline-block';
    if (data.resources && data.resources.length > 0) portal.querySelector('[data-tab="resource-pane"]').style.display = 'inline-block';
    
    renderUserInfo(currentUser);
}

function renderWidgets(widgets) {
    if (!widgets || widgets.length === 0) return '';
    const widgetHtml = widgets.map(widget => {
        let contentHtml = widget.ÎÇ¥Ïö© || '';
        if (widget.ÏúÑÏ†ØÏ¢ÖÎ•ò === 'ÎîîÎç∞Ïù¥') {
            const targetDate = new Date(contentHtml);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            contentHtml = diff === 0 ? "D-Day" : diff > 0 ? `D-${diff}` : `D+${-diff}`;
        }
        return `<div class="widget"><div class="widget-title">${widget.Ï†úÎ™© || ''}</div><div class="widget-content">${contentHtml}</div></div>`;
    }).join('');
    return `<div id="widgets-container">${widgetHtml}</div>`;
}

function renderUnsubmitted(tasks) {
    if (!tasks || tasks.length === 0) return '';
    const listHtml = tasks.map(t => `<li>üëå ${t.Ï†úÎ™© || t.ÎÇ¥Ïö© || ''}</li>`).join('');
    return `<div class="unsubmitted-section"><p>üîî ÏïÑÏßÅ ÏôÑÎ£åÌïòÏßÄ ÏïäÏùÄ Ìï† ÏùºÏù¥ ÏûàÏñ¥Ïöî!</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">${listHtml}</ul></div>`;
}

function renderStudentClassSchedules(schedules) {
    if (!schedules || schedules.length === 0) return '';
    const schedulesHtml = schedules.map(s => `<div class="card"><p>${s.Ï†úÎ™© || ''}</p></div>`).join('');
    return `<div class="section"><h2 class="section-title">üóìÔ∏è ÌïôÍ∏â ÏùºÏ†ï</h2><div class="grid-container">${schedulesHtml}</div></div>`;
}

function renderItemsSection(type, items, sectionTitle) {
    const unreadItems = (items || []).filter(item => !completedItems[item.id]);
    if (unreadItems.length === 0) {
        return `<div class="section"><h2 class="section-title">${sectionTitle}</h2><div class="empty-state">Î™®Îëê ÌôïÏù∏ÌñàÏäµÎãàÎã§! üëç</div></div>`;
    }

    const itemsHtml = unreadItems.map(item => {
        const isTask = type === 'tasks';
        const actionButton = isTask
            ? `<a href="${item.ÎßÅÌÅ¨ || '#'}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">Í∏∞Î°ùÌïòÍ∏∞</a>`
            : (item.ÎßÅÌÅ¨ ? `<a href="${item.ÎßÅÌÅ¨}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">Î∞îÎ°úÍ∞ÄÍ∏∞</a>` : '');

        return `<div class="notice-item" id="${item.id}">
                    <div style="flex-grow: 1;">
                        <div class="card-title">${item.ÏïÑÏù¥ÏΩò || ''} ${item.Ï†úÎ™© || ''}</div>
                        <p class="card-description">${item.ÎÇ¥Ïö© || ''}</p>
                        ${actionButton}
                    </div>
                    <button class="complete-btn" onclick="completeItem('${item.id}')">ÌôïÏù∏</button>
                </div>`;
    }).join('');

    return `<div class="section"><h2 class="section-title">${sectionTitle}</h2>${itemsHtml}</div>`;
}

function completeItem(itemId) {
    completedItems[itemId] = true;
    saveCompletedItems();
    const itemElement = document.getElementById(itemId);
    if (itemElement) {
        itemElement.style.transition = 'opacity 0.3s, transform 0.3s';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateY(-10px)';
        setTimeout(() => { itemElement.remove(); }, 300);
    }
}

function renderLeaveSection(requests) {
    const historyHtml = (!requests || requests.length === 0) ? '<div class="empty-state">Ïã†Ï≤≠ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>' : requests.map(req => {
        const requestDate = req.Ìù¨ÎßùÏùºÏûê ? new Date(req.Ìù¨ÎßùÏùºÏûê).toLocaleDateString() : 'ÎÇ†Ïßú ÏóÜÏùå';
        const certButton = (req.ÏÉÅÌÉú === 'ÏäπÏù∏' && req.Ïã†Ï≤≠ÌñâÎ≤àÌò∏) ? `<a href="${SCRIPT_URL}?action=getCertificate&rowNum=${req.Ïã†Ï≤≠ÌñâÎ≤àÌò∏}" target="_blank" class="action-btn" style="background-color:#17a2b8; padding: 5px 10px; font-size: 0.8em; margin: 0;">ÌôïÏù∏Ï¶ù</a>` : '';
        return `<div class="card">
                    <div>
                        <strong>${req.Ïã†Ï≤≠Ï¢ÖÎ•ò}</strong> (${requestDate})<br>
                        <small>ÏÇ¨Ïú†: ${req.ÏÇ¨Ïú† || ''}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="status-badge status-${req.ÏÉÅÌÉú}">${req.ÏÉÅÌÉú}</span>
                        ${certButton}
                    </div>
                </div>`;
    }).join('');
    
    return `<div class="leave-form">
                <h2 class="section-title" style="border: none; margin-bottom: 20px;">Ïô∏Ï∂ú/Ï°∞Ìá¥ Ïã†Ï≤≠ÌïòÍ∏∞</h2>
                <form id="leave-request-form">
                    <div class="form-group">
                        <label>Ïã†Ï≤≠ Ï¢ÖÎ•ò</label>
                        <div class="leave-type-buttons">
                            <button type="button" class="leave-type-btn selected" data-type="Ïô∏Ï∂ú">Ïô∏Ï∂ú</button>
                            <button type="button" class="leave-type-btn" data-type="Ï°∞Ìá¥">Ï°∞Ìá¥</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ìù¨Îßù ÏùºÏûê</label>
                        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>ÏÇ¨Ïú†</label>
                        <textarea name="reason" rows="3" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="action-btn">Ïã†Ï≤≠ Ï†úÏ∂ú</button>
                    </div>
                </form>
            </div>
            <div class="section leave-history">
                <h2 class="section-title">ÎÇòÏùò Ïã†Ï≤≠ ÎÇ¥Ïó≠</h2>
                ${historyHtml}
            </div>`;
}

function renderResources(resources) {
    if (!resources || resources.length === 0) return '<div class="empty-state">Îì±Î°ùÎêú ÏûêÎ£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    const resourcesHtml = resources.map(res => `<div class="card"><a href="${res.ÎßÅÌÅ¨ || '#'}" target="_blank" style="text-decoration: none; color: var(--primary-color); font-weight: 600;">${res.ÏûêÎ£åÎ™Ö || ''}</a></div>`).join('');
    return `<div class="section grid-container">${resourcesHtml}</div>`;
}

async function submitLeaveRequest(form) {
    const type = form.querySelector('.leave-type-btn.selected')?.dataset.type;
    if (!type) {
        alert('Ïã†Ï≤≠ Ï¢ÖÎ•ò(Ïô∏Ï∂ú ÎòêÎäî Ï°∞Ìá¥)Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
    }
    
    const params = new URLSearchParams({ 
        action: 'submitLeaveRequest', 
        studentId: currentUser.studentId, 
        name: currentUser.name, 
        email: currentUser.email,
        type: type,
        date: form.date.value,
        reason: form.reason.value
    });
    
    alert('Ïã†Ï≤≠ Ï≤òÎ¶¨ Ï§ë...');
    try {
        const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await res.json();
        alert(result.message);
        if (result.status === 'success') loadData();
    } catch (error) { alert('Ïã†Ï≤≠ Ï§ë Ïò§Î•ò: ' + error.message); }
}
</script>
</body>
</html>
