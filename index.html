<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ í•™ê¸‰ ê´€ë¦¬ í”Œë«í¼</title>
    <link rel="icon" type="image/png" href="/portal-dev/favicon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
    :root { --primary-color: #5D78E6; --secondary-color: #A25AF2; --light-bg: #f4f6fc; --white-bg: #ffffff; --text-dark: #212529; --text-light: #6c757d; --border-color: #e9ecef; --border-radius: 12px; --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.06); }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--light-bg); min-height: 100vh; padding: 20px; color: var(--text-dark); }
    .container { max-width: 800px; margin: 0 auto; background: var(--white-bg); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 40px 30px; text-align: center; }
    .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 10px; }
    .header .date-display { font-size: 1.2em; opacity: 0.9; }
    .content { padding: 30px; }
    .empty-state { text-align: center; padding: 40px; color: var(--text-light); font-size: 1.1em; }
    .section { margin-bottom: 30px; }
    .section-title { font-size: 1.4em; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
    
    /* â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ì¹´ë“œ ë””ìì¸ ìˆ˜ì • â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ */

    /* [ìˆ˜ì • 1] ì¹´ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼: ì™¼ìª½ í…Œë‘ë¦¬ ì¶”ê°€ ë° íŒ¨ë”© ì¡°ì • */
    .card {
        background: var(--white-bg);
        border-radius: var(--border-radius);
        padding: 15px 20px; /* ìœ„ì•„ë˜ íŒ¨ë”©ì„ ì‚´ì§ ì¡°ì • */
        box-shadow: var(--shadow-light);
        border: 1px solid var(--border-color);
        border-left: 5px solid var(--primary-color); /* << íŒŒë€ìƒ‰ ì™¼ìª½ í…Œë‘ë¦¬ ì¶”ê°€ */
    }

    /* [ìˆ˜ì • 2] ì¹´ë“œ ì œëª© ìŠ¤íƒ€ì¼: í°íŠ¸ í¬ê¸°, êµµê¸°, ìƒ‰ìƒ ë³€ê²½ */
    .card-title {
        font-size: 1.15em; /* << ê¸€ì í¬ê¸° í‚¤ì›€ */
        font-weight: 700;   /* << ê¸€ì ë” êµµê²Œ */
        margin-bottom: 6px;
        color: #3D4A81;   /* << ì´ë¯¸ì§€ì™€ ìœ ì‚¬í•œ ì°¨ë¶„í•œ ë‚¨ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
    }

    /* [ìˆ˜ì • 3] ì¹´ë“œ ì„¤ëª… ìŠ¤íƒ€ì¼: í°íŠ¸ í¬ê¸° ì¡°ì • */
    .card-description {
        font-size: 0.9em; /* << ê¸€ì í¬ê¸° ì•½ê°„ ì‘ê²Œ ì¡°ì • */
        color: var(--text-light);
        line-height: 1.6;
    }

    /* â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² ì¹´ë“œ ë””ìì¸ ìˆ˜ì • â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² */

    a.card { text-decoration: none; color: inherit; display: block; transition: transform 0.2s; }
    a.card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .action-btn { padding: 8px 16px; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500; text-decoration: none; display: inline-block; margin-top: 12px; }
    .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; }
    .tab-button { padding: 12px 18px; cursor: pointer; border: none; background: none; font-size: 1em; font-weight: 500; color: var(--text-light); position: relative; }
    .tab-button.active { color: var(--primary-color); font-weight: 600; }
    .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--primary-color); border-radius: 3px; }
    .tab-pane { display: none; } .tab-pane.active { display: block; } /* [ìˆ˜ì •] tab-paneì„ gridì—ì„œ blockìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ë‚´ë¶€ ê·¸ë¦¬ë“œê°€ ì˜ ì ìš©ë˜ë„ë¡ í•¨ */
    .user-display { display: flex; align-items: center; gap: 12px; }
    .user-profile-image { width: 36px; height: 36px; border-radius: 50%; }
    .user-initial { width: 36px; height: 36px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .user-name-logout { font-size: 0.9em; text-align: left; }
    .user-name-logout strong { display: block; }
    .user-name-logout a { text-decoration: none; }
    .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .student-header { padding: 0 30px; background-color: #fff; min-height: 60px; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid var(--border-color); }
    .student-header .user-name-logout { color: var(--text-dark); }
    .student-header .user-name-logout a { color: var(--text-light); }
    #widgets-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .widget { background-color: var(--white-bg); padding: 20px; text-align: center; border-radius: var(--border-radius); box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
    .widget-title { font-weight: 500; margin-bottom: 8px; color: var(--text-light); }
    .widget-content { font-size: 2.2em; font-weight: 700; color: var(--primary-color); }
    .unsubmitted-section { background-color: #fff9e6; border: 1px solid #ffe7ab; color: #8a6d3b; padding: 15px 20px; margin-bottom: 30px; border-radius: var(--border-radius); }
    .notice-item.card { border-left: 4px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; }
    .complete-btn { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 14px; border-radius: 20px; cursor: pointer; font-size: 0.9em; flex-shrink: 0; margin-left: 15px; }
    .leave-form { background: #f8f9fa; padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
    .leave-type-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .leave-type-btn { background-color: #e9ecef; color: #495057; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
    .leave-type-btn.selected { background-color: var(--primary-color); color: white; font-weight: 600; }
    .form-actions { text-align: right; } .form-actions .action-btn { color: white; background-color: var(--primary-color); }
    .leave-history .card { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 600; color: white; }
    .status-ìŠ¹ì¸ { background-color: #28a745; } .status-ë°˜ë ¤ { background-color: #dc3545; } .status-ì‹ ì²­ { background-color: #ffc107; }
    .teacher-header { padding: 0 30px; background-color: #343a40; min-height: 60px; display: flex; justify-content: flex-end; align-items: center; }
    .teacher-header .user-name-logout { color: white; } .teacher-header .user-name-logout a { color: #adb5bd; }
    .routine-tasks-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .routine-item { background: #f1f3f5; border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 15px; display: inline-flex; align-items: center; cursor: pointer; }
    .routine-item.completed { background-color: #e0e7ff; border-color: var(--primary-color); color: var(--primary-color); font-weight: 500; }
    .routine-checkbox { display: none; }
    .accordion-item { margin-bottom: 5px; }
    .accordion-title { background: #f8f9fa; border-radius: 8px; padding: 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .accordion-title.active::after { transform: rotate(180deg); } .accordion-title::after { content: 'â–¼'; transition: transform 0.2s; }
    .accordion-content { display: none; padding: 15px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; }
    .teacher-leave-card { display: flex; flex-direction: column; gap: 10px; }
    .leave-reason-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    .leave-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .approve-btn { background: #28a745; } .reject-btn { background: #dc3545; }
    .post-filter-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .post-search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    .post-filter-tabs { display: flex; }
    .post-filter-btn { padding: 8px 14px; border: 1px solid #ccc; background-color: var(--white-bg); cursor: pointer; border-radius: 0; }
    .post-filter-btn:first-child { border-radius: 6px 0 0 6px;} .post-filter-btn:last-child { border-radius: 0 6px 6px 0; border-left: none; }
    .post-filter-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); } input:checked + .slider:before { transform: translateX(22px); }
    .teacher-dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--white-bg); padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 500px; }
    .modal-close-btn { float: right; background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-light); }
/* ì¹´ë“œì˜ ë‚ ì§œ/ê¸°ê°„ í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
.card-date {
    font-size: 0.8em;
    font-weight: 500;
    color: var(--text-light);
    margin-bottom: 8px;
}
/* ì´ ì½”ë“œë¡œ ê¸°ì¡´ unsubmitted ê´€ë ¨ CSSë¥¼ ëª¨ë‘ êµì²´í•˜ì„¸ìš”. */

/* ì´ì œ unsubmitted-sectionì€ ë‹¤ë¥¸ sectionê³¼ ë™ì¼í•˜ì§€ë§Œ, ì œëª© ë””ìì¸ë§Œ ë‹¤ë¥´ê²Œ í•©ë‹ˆë‹¤. */
.unsubmitted-section .section-title {
    color: #b38600; /* ì£¼ëª©ë„ë¥¼ ë†’ì´ëŠ” ì°¨ë¶„í•œ í™©ê¸ˆìƒ‰ ê³„ì—´ */
    border-bottom-color: #ffeeba; /* ì œëª© ì•„ë˜ ë°‘ì¤„ ìƒ‰ìƒ */
}

/* ë¯¸ì œì¶œ í•  ì¼ ì¹´ë“œë“¤ì„ ë‹´ëŠ” ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ */
.unsubmitted-grid {
    display: grid;
    gap: 10px; /* ê° ì¹´ë“œ ì‚¬ì´ì˜ ê°„ê²© */
}

/* ë¯¸ì œì¶œ í•  ì¼ ì¹´ë“œ ê°œë³„ ìŠ¤íƒ€ì¼ */
.unsubmitted-task-card {
    display: block; /* a íƒœê·¸ë¥¼ ë¸”ë¡ ìš”ì†Œì²˜ëŸ¼ ë³´ì´ê²Œ */
    text-decoration: none; /* ë°‘ì¤„ ì œê±° */
    font-weight: 500;
    color: #634e2c;
    /* ì¹´ë“œì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜, ë°°ê²½ìƒ‰ê³¼ ì™¼ìª½ í…Œë‘ë¦¬ ìƒ‰ë§Œ ì‚´ì§ ë³€ê²½í•˜ì—¬ ê°•ì¡° */
    background-color: #fffaf0; /* ë§¤ìš° ì—°í•œ í¬ë¦¼ìƒ‰ ë°°ê²½ */
    border-left-color: #ffc107; /* ë…¸ë€ìƒ‰ ì™¼ìª½ í…Œë‘ë¦¬ */
    transition: transform 0.2s;
}

.unsubmitted-task-card:hover {
    transform: translateY(-2px); /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì‚´ì§ ë– ì˜¤ë¥´ëŠ” íš¨ê³¼ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
</style>
</head>
<body>
    <div class="container">
        <div id="app-root"><div class="empty-state"><div id="gsi-container"></div></div></div>
    </div>
    <div id="new-post-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">Ã—</button>
            <h2>âœ¨ ìƒˆ ê²Œì‹œë¬¼/ì—…ë¬´ ë“±ë¡</h2>
            <form id="new-post-form" style="margin-top: 20px;">
                <div class="form-group"><label>ìœ í˜•</label><select name="type"><option value="ê³µì§€">ê³µì§€</option><option value="í• ì¼">í•  ì¼</option></select></div>
                <div class="form-group"><label>ì œëª©</label><input type="text" name="title" required></div>
                <div class="form-group"><label>ë‚´ìš©</label><textarea name="content" rows="4"></textarea></div>
                <div class="form-group"><label>ë§í¬ (ì„ íƒ)</label><input type="url" name="link"></div>
                <div class="form-actions"><button type="submit" class="action-btn">ë“±ë¡í•˜ê¸°</button></div>
            </form>
        </div>
    </div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxlM_uuJgNqbB3dU7n2x6L5pzmKXWTAmE7lcYcks8V9QB5ld56q43G1GEc0geo1yRBA/exec';
const GOOGLE_CLIENT_ID = '209932065927-v6kg2bd8gmgfdrksaqrhb7lqo12j6vrf.apps.googleusercontent.com';

let currentUser = null;
let completedItems = {};
const urlParams = new URLSearchParams(window.location.search);
const isTeacherMode = urlParams.get('mode') === 'teacher';

window.onload = function() {
    try { currentUser = JSON.parse(localStorage.getItem('userInfo')); } catch (e) { localStorage.removeItem('userInfo'); }
    loadCompletedItems();
    if (currentUser) {
        loadData();
    } else {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse, ux_mode: 'redirect',
            login_uri: window.location.origin + window.location.pathname + (isTeacherMode ? '?mode=teacher' : '')
        });
        google.accounts.id.prompt((n) => { if (n.isNotDisplayed()) { google.accounts.id.renderButton(document.getElementById('gsi-container'), { theme: 'outline', size: 'large' }); }});
    }
    setupEventListeners();
};

async function loadData() {
    const root = document.getElementById('app-root');
    root.innerHTML = '<div class="empty-state">ğŸ”„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    const fullUrl = `${SCRIPT_URL}?v=${new Date().getTime()}&email=${encodeURIComponent(currentUser.email)}` + (isTeacherMode ? '&mode=teacher' : '');
    try {
        const response = await fetch(fullUrl);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        currentUser = { ...currentUser, ...data.user };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        if (isTeacherMode) {
            root.innerHTML = renderTeacherDashboard(data);
        } else {
            root.innerHTML = renderStudentPortal(data);
        }
        renderUserInfo(currentUser);
    } catch (error) {
        root.innerHTML = `<div class="empty-state">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
    }
}

function setupEventListeners() {
    document.body.addEventListener('click', function(e) {
        const target = e.target;
        if (target.closest('.tab-button')) {
            const button = target.closest('.tab-button');
            const targetPaneId = button.dataset.tab;
            const tabContainer = button.closest('.tabs');
            tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const contentContainer = tabContainer.nextElementSibling;
            contentContainer.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(targetPaneId).classList.add('active');
        }
        if (target.closest('.accordion-title')) { target.closest('.accordion-title').classList.toggle('active'); const content = target.closest('.accordion-title').nextElementSibling; if (content) { content.style.display = content.style.display === 'block' ? 'none' : 'block'; } }
        if (target.closest('#new-post-btn')) { document.getElementById('new-post-modal').style.display = 'flex'; }
        if (target.closest('.modal-close-btn')) { target.closest('.modal-overlay').style.display = 'none'; }
        if (target.closest('.leave-type-btn')) { document.querySelectorAll('.leave-type-btn').forEach(btn => btn.classList.remove('selected')); target.classList.add('selected'); }
    });
    document.body.addEventListener('submit', function(e) { if (e.target.id === 'leave-request-form') { e.preventDefault(); submitLeaveRequest(e.target); } if (e.target.id === 'new-post-form') { e.preventDefault(); submitNewPost(e.target); } });
}

function renderTeacherSettings(data) {
    // ë°ì´í„°ë¥¼ 'ì¢…ë¥˜'ë³„ë¡œ ê·¸ë£¹í™”í•©ë‹ˆë‹¤. ì¢…ë¥˜ê°€ ì—†ìœ¼ë©´ 'ê¸°íƒ€'ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.
    const groupedItems = (data.dashboardItems || []).reduce((acc, item) => {
        const type = item.ì¢…ë¥˜ || 'ê¸°íƒ€';
        if (!acc[type]) acc[type] = [];
        acc[type].push(item);
        return acc;
    }, {});

    // ê·¸ë£¹í™”ëœ ë°ì´í„°ì˜ í‚¤(íƒ­ ì´ë¦„)ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const tabs = Object.keys(groupedItems);

    // íƒ­ ë²„íŠ¼ HTMLì„ ìƒì„±í•©ë‹ˆë‹¤.
    const tabButtonsHtml = tabs.map((tab, i) =>
        `<button class="tab-button ${i === 0 ? 'active' : ''}" data-tab="teacher-tab-${i}">${tab}</button>`
    ).join('');

    // íƒ­ ì½˜í…ì¸ (ì°½) HTMLì„ ìƒì„±í•©ë‹ˆë‹¤.
    const tabPanesHtml = tabs.map((tab, i) => {
        const itemsHtml = groupedItems[tab].map(item =>
            `<a href="${item.ë§í¬}" target="_blank" class="card">
                <div class="card-title">${item.ì—…ë¬´ëª…}</div>
                <p class="card-description">${item.ìƒì„¸ë‚´ìš© || ''}</p>
            </a>`
        ).join('');

        // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: ê° íƒ­ì˜ ì½˜í…ì¸ ë¥¼ 'teacher-dashboard-grid' í´ë˜ìŠ¤ë¡œ ê°ì‹¸ì¤ë‹ˆë‹¤.
        return `
            <div id="teacher-tab-${i}" class="tab-pane ${i === 0 ? 'active' : ''}">
                <div class="teacher-dashboard-grid">${itemsHtml}</div>
            </div>`;
    }).join('');

    // ìµœì¢…ì ìœ¼ë¡œ ë Œë”ë§í•  ì „ì²´ HTML êµ¬ì¡°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    return `
        <div class="section">
            <h2 class="section-title">âš™ï¸ ì„¤ì •</h2>
            <div class="teacher-dashboard-grid">
                <div id="new-post-btn" class="card" style="cursor:pointer; text-align:center; display:flex; align-items:center; justify-content:center;">
                    <div class="card-title">âœ¨ ìƒˆ ê²Œì‹œë¬¼/ì—…ë¬´ ë“±ë¡</div>
                </div>
                <a href="${data.sheetUrl}" target="_blank" class="card" style="display:flex; align-items:center; justify-content:center;">
                    <div class="card-title">ğŸ“Š ë°ì´í„° ì‹œíŠ¸ ìˆ˜ì •</div>
                </a>
            </div>
            <div class="tabs">${tabButtonsHtml}</div>
            <div class="tab-content">${tabPanesHtml}</div>
        </div>`;
}
// ... ì´ ì•„ë˜ë¡œ ë‚˜ë¨¸ì§€ ëª¨ë“  ìë°”ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ë“¤ì´ ìœ„ì¹˜í•©ë‹ˆë‹¤ (ìƒëµ ì—†ìŒ) ...
function loadCompletedItems() { const todayStr = new Date().toISOString().split('T')[0]; const storedData = localStorage.getItem('completedItems'); if (storedData) { try { const data = JSON.parse(storedData); if (data.date === todayStr) { completedItems = data.items || {}; } else { localStorage.removeItem('completedItems'); completedItems = {}; } } catch (e) { localStorage.removeItem('completedItems'); completedItems = {}; } } }
function saveCompletedItems() { localStorage.setItem('completedItems', JSON.stringify({ date: new Date().toISOString().split('T')[0], items: completedItems }));}
async function handleCredentialResponse(response) { if (response && response.credential) { const userObject = JSON.parse(atob(response.credential.split('.')[1])); currentUser = { name: userObject.name, email: userObject.email, picture: userObject.picture }; localStorage.setItem('userInfo', JSON.stringify(currentUser)); const cleanUrl = window.location.origin + window.location.pathname + (isTeacherMode ? '?mode=teacher' : ''); window.location.href = cleanUrl; } }
function handleLogout() { localStorage.clear(); google.accounts.id.disableAutoSelect(); location.reload(); }
function renderUserInfo(user) { const displayEl = document.getElementById('user-display'); if (!displayEl) return; let userInitial = ''; const nameParts = (user.name || '').split(''); if (nameParts.length > 1) { userInitial = nameParts[0] + nameParts[nameParts.length - 1]; } else { userInitial = nameParts[0] || ''; } const userProfileHtml = user.picture ? `<img src="${user.picture}" class="user-profile-image" alt="profile">` : `<div class="user-initial">${userInitial}</div>`; displayEl.innerHTML = `<div class="user-display">${userProfileHtml}<div class="user-name-logout"><strong>${user.name}</strong><a href="#" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</a></div></div>`; }
function renderStudentPortal(data) { return ` <div class="student-header"><div id="user-display"></div></div> <div class="header"> <h1>ğŸ“¢ ì˜¤ëŠ˜ì˜ ì•Œë¦¼</h1> <div class="date-display">${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</div> </div> <div class="content"> ${renderWidgets(data.widgets)} ${renderUnsubmitted(data.unsubmitted)} ${renderStudentClassSchedules(data.classSchedules)} <div class="tabs"> <button class="tab-button active" data-tab="main-pane">ì•Œë¦¼ & í•  ì¼</button> <button class="tab-button" data-tab="leave-pane" style="${data.user?.studentId ? '' : 'display:none;'}">ì™¸ì¶œ/ì¡°í‡´</button> <button class="tab-button" data-tab="resource-pane" style="${(data.resources || []).length > 0 ? '' : 'display:none;'}">ìë£Œì‹¤</button> </div> <div class="tab-content"> <div id="main-pane" class="tab-pane active">${renderItemsSection('notices', data.notices, 'ğŸ“Œ ì¤‘ìš” ê³µì§€')} ${renderItemsSection('tasks', data.tasks, 'âœ… ì˜¤ëŠ˜ì˜ í•  ì¼')}</div> <div id="leave-pane" class="tab-pane">${renderLeaveSection(data.leaveRequests)}</div> <div id="resource-pane" class="tab-pane">${renderResources(data.resources)}</div> </div> </div> `; }
function renderTeacherDashboard(data) { return ` <div class="teacher-header"><div id="user-display"></div></div> <div class="header"> <h1>ğŸ’¼ ì—…ë¬´ ëŒ€ì‹œë³´ë“œ</h1> <div class="date-display">${new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</div> </div> <div class="content"> ${renderTeacherRoutines(data.routines)} ${renderClassManagement(data)} ${renderTeacherPersonalTasks(data.teacherPersonalTasks)} ${renderTeacherSettings(data)} </div> `; }
function renderWidgets(widgets) { if (!widgets || widgets.length === 0) return ''; const widgetHtml = widgets.map(widget => { let contentHtml = widget.ë‚´ìš© || ''; if (widget.ìœ„ì ¯ì¢…ë¥˜ === 'ë””ë°ì´') { const targetDate = new Date(contentHtml); const today = new Date(); today.setHours(0, 0, 0, 0); const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24)); contentHtml = diff === 0 ? "D-Day" : diff > 0 ? `D-${diff}` : `D+${-diff}`; } return `<div class="widget"><div class="widget-title">${widget.ì œëª© || ''}</div><div class="widget-content">${contentHtml}</div></div>`; }).join(''); return `<div id="widgets-container">${widgetHtml}</div>`;}
// ì´ ì½”ë“œë¡œ ê¸°ì¡´ renderUnsubmitted í•¨ìˆ˜ ì „ì²´ë¥¼ êµì²´í•˜ì„¸ìš”.
function renderUnsubmitted(tasks) {
    // í•  ì¼ì´ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    if (!tasks || tasks.length === 0) return '';

    // â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜…
    // ê° í•  ì¼ì„ ê°œë³„ì ì¸ 'ì¹´ë“œ'ë¡œ ë§Œë“­ë‹ˆë‹¤.
    // ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ í˜ì´ì§€ ë‚´ì˜ í•´ë‹¹ í•  ì¼ ìœ„ì¹˜ë¡œ ì´ë™í•˜ë„ë¡ ë§í¬(#id)ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    const listHtml = tasks.map(task => 
        `<a href="#${task.id}" class="card unsubmitted-task-card">
            ${task.ì•„ì´ì½˜ || 'ğŸ‘‰'} ${task.ì œëª© || task.ë‚´ìš©}
        </a>`
    ).join('');

    // ì´ì œ ì´ ì„¹ì…˜ì€ ë‹¤ë¥¸ ì„¹ì…˜ë“¤ê³¼ ë™ì¼í•œ êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
    return `
        <div class="section unsubmitted-section">
            <h2 class="section-title">ğŸ”” ì•„ì§ ì™„ë£Œí•˜ì§€ ì•Šì€ í•  ì¼ì´ ìˆì–´ìš”!</h2>
            <div class="unsubmitted-grid">${listHtml}</div>
        </div>
    `;
}
    
    
    
    function renderStudentClassSchedules(schedules) {
    // ì¼ì •ì´ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    if (!schedules || schedules.length === 0) return '';

    // â˜… ìˆ˜ì • 1: ì¼ì •ì„ ì‹œì‘ì¼(ì˜¤ë¦„ì°¨ìˆœ) ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
    schedules.sort((a, b) => new Date(a['ì¼ì • ì‹œì‘ì¼']) - new Date(b['ì¼ì • ì‹œì‘ì¼']));

    const schedulesHtml = schedules.map(s => {
        const titleHtml = `<div class="card-title">${s.ì•„ì´ì½˜ || ''} ${s.ì œëª© || ''}</div>`;
        const descriptionHtml = s.ë‚´ìš© ? `<p class="card-description">${s.ë‚´ìš©}</p>` : '';

        // â˜… ìˆ˜ì • 2: ê¸°ê°„ í‘œì‹œë¥¼ ìœ„í•œ HTMLì„ ìƒì„±í•©ë‹ˆë‹¤.
        let dateHtml = '';
        const startDate = s['ì¼ì • ì‹œì‘ì¼'];
        const endDate = s['ì¼ì • ì¢…ë£Œì¼'];

        if (startDate) {
            let dateString = new Date(startDate).toLocaleDateString('ko-KR');
            if (endDate && endDate !== startDate) {
                dateString += ` ~ ${new Date(endDate).toLocaleDateString('ko-KR')}`;
            }
            dateHtml = `<p class="card-date">${dateString}</p>`;
        }

        return `
            <div class="card">
                ${titleHtml}
                ${dateHtml}
                ${descriptionHtml}
            </div>`;
    }).join('');

    return `
        <div class="section">
            <h2 class="section-title">ğŸ—“ï¸ í•™ê¸‰ ì¼ì •</h2>
            <div class="grid-container">${schedulesHtml}</div>
        </div>`;
}
    
    
    
// ì´ ì½”ë“œë¡œ ê¸°ì¡´ renderItemsSection í•¨ìˆ˜ ì „ì²´ë¥¼ êµì²´í•˜ì„¸ìš”.
function renderItemsSection(type, items, sectionTitle) {
    // ì •ë ¬ ë¡œì§ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
    (items || []).sort((a, b) => {
        const orderA = a.ì •ë ¬ìˆœì„œ !== undefined && a.ì •ë ¬ìˆœì„œ !== '' ? parseInt(a.ì •ë ¬ìˆœì„œ) : Infinity;
        const orderB = b.ì •ë ¬ìˆœì„œ !== undefined && b.ì •ë ¬ìˆœì„œ !== '' ? parseInt(b.ì •ë ¬ìˆœì„œ) : Infinity;
        if (orderA !== orderB) {
            return orderA - orderB;
        }
        return (b.id || '').localeCompare(a.id || '');
    });
    
    const unreadItems = (items || []).filter(item => !completedItems[item.id]);

    if (unreadItems.length === 0) {
        return `<div class="section"><h2 class="section-title">${sectionTitle}</h2><div class="empty-state">ëª¨ë‘ í™•ì¸í–ˆìŠµë‹ˆë‹¤! ğŸ‘</div></div>`;
    }

    const itemsHtml = unreadItems.map(item => {
        // â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜…
        // 'ê¸°ë¡ì—¬ë¶€'ê°€ 'Y'ì¸ì§€ì— ë”°ë¼ isTask ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        const isTask = item.ê¸°ë¡ì—¬ë¶€ === 'Y'; 
        
        const actionButton = isTask 
            ? `<a href="${item.ë§í¬ || '#'}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">ê¸°ë¡í•˜ê¸°</a>` 
            : (item.ë§í¬ ? `<a href="${item.ë§í¬}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">ë°”ë¡œê°€ê¸°</a>` : '');
        
        // 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ completeItem í•¨ìˆ˜ì— isTask ê°’ì„ í•¨ê»˜ ë„˜ê²¨ì¤ë‹ˆë‹¤.
        const completeButton = `<button class="complete-btn" onclick="completeItem('${item.id}', ${isTask})">í™•ì¸</button>`;

        return `
            <div class="notice-item card" id="${item.id}">
                <div style="flex-grow: 1;">
                    <div class="card-title">${item.ì•„ì´ì½˜ || ''} ${item.ì œëª© || ''}</div>
                    <p class="card-description">${item.ë‚´ìš© || ''}</p>
                    ${actionButton}
                </div>
                ${completeButton}
            </div>`;
    }).join('');

    return `<div class="section"><h2 class="section-title">${sectionTitle}</h2>${itemsHtml}</div>`;
}
    
    
    
    
// ì´ ì½”ë“œë¡œ ê¸°ì¡´ completeItem í•¨ìˆ˜ ì „ì²´ë¥¼ êµì²´í•˜ì„¸ìš”.
async function completeItem(itemId, isTask = false) {
    const itemElement = document.getElementById(itemId);

    // í•™ìƒ í™”ë©´ì—ì„œ ì¦‰ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬ (ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ)
    if (itemElement) {
        itemElement.style.transition = 'opacity 0.3s, transform 0.3s';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateY(-10px)';
        setTimeout(() => { itemElement.remove(); }, 300);
    }
    
    // ë¡œì»¬ ì €ì¥ì†Œì—ë„ í™•ì¸ ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤.
    completedItems[itemId] = true; 
    saveCompletedItems();

    // â˜…â˜…â˜… ì¶”ê°€ëœ ë¶€ë¶„ â˜…â˜…â˜…
    // isTaskê°€ trueì¼ ê²½ìš° ('ê¸°ë¡í•˜ê¸°'ê°€ ê°€ëŠ¥í•œ ê³¼ì œì¼ ê²½ìš°) ì„œë²„ë¡œ ì œì¶œ ê¸°ë¡ì„ ì „ì†¡í•©ë‹ˆë‹¤.
    if (isTask && currentUser && currentUser.studentId) {
        try {
            const params = new URLSearchParams({
                action: 'recordSubmission', // ìƒˆë¡œìš´ ì•¡ì…˜ ì´ë¦„
                studentId: currentUser.studentId,
                name: currentUser.name,
                taskId: itemId
            });
            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì¡°ìš©íˆ ì „ì†¡í•©ë‹ˆë‹¤. (ì„±ê³µ ì—¬ë¶€ë¥¼ í•™ìƒì—ê²Œ ì•Œë¦¬ì§€ ì•ŠìŒ)
            await fetch(`${SCRIPT_URL}?${params.toString()}`);
        } catch (error) {
            console.error('ì œì¶œ ê¸°ë¡ ì „ì†¡ ì‹¤íŒ¨:', error);
            // í•„ìš”í•˜ë‹¤ë©´ ë‚˜ì¤‘ì— ì¬ì „ì†¡í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        }
    }
}
    
    
    
    
    
    function renderLeaveSection(requests) {
    // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: UTC ê¸°ì¤€ì´ ì•„ë‹Œ, ì‚¬ìš©ìì˜ í˜„ì§€ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ(YYYY-MM-DD)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1, ë‘ ìë¦¬ë¡œ ë§ì¶¤
    const day = String(today.getDate()).padStart(2, '0');        // ì¼ìë¥¼ ë‘ ìë¦¬ë¡œ ë§ì¶¤
    const localTodayStr = `${year}-${month}-${day}`;

    const historyHtml = (!requests || requests.length === 0) ? '<div class="empty-state">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>' : requests.map(req => {
        const requestDate = req.í¬ë§ì¼ì ? new Date(req.í¬ë§ì¼ì) : null;
        const requestDateStr = requestDate ? requestDate.toISOString().split('T')[0] : '';
        
        // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: í™•ì¸ì¦ ë²„íŠ¼ í‘œì‹œ ì¡°ê±´ì„ í˜„ì§€ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        const certButton = (req.ìƒíƒœ === 'ìŠ¹ì¸' && req.ì‹ ì²­í–‰ë²ˆí˜¸ && requestDateStr === localTodayStr) 
            ? `<a href="${SCRIPT_URL}?action=getCertificate&rowNum=${req.ì‹ ì²­í–‰ë²ˆí˜¸}" target="_blank" class="action-btn" style="background-color:#17a2b8; padding: 5px 10px; font-size: 0.8em; margin: 0;">í™•ì¸ì¦</a>` 
            : '';

        // ì¹´ë“œ ì œëª©ì— í‘œì‹œë  ë‚ ì§œ í¬ë§·
        const displayDate = requestDate ? `${requestDate.getFullYear()}. ${requestDate.getMonth() + 1}. ${requestDate.getDate()}.` : 'ë‚ ì§œ ì—†ìŒ';

        return `
            <div class="card">
                <div>
                    <strong>${req.ì‹ ì²­ì¢…ë¥˜}</strong> (${displayDate})<br>
                    <small>ì‚¬ìœ : ${req.ì‚¬ìœ  || ''}</small>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="status-badge status-${req.ìƒíƒœ}">${req.ìƒíƒœ}</span>
                    ${certButton}
                </div>
            </div>`;
    }).join('');

    return `
        <div class="leave-form">
            <h2 class="section-title" style="border: none; margin-bottom: 20px;">ì™¸ì¶œ/ì¡°í‡´ ì‹ ì²­í•˜ê¸°</h2>
            <form id="leave-request-form">
                <div class="form-group">
                    <label>ì‹ ì²­ ì¢…ë¥˜</label>
                    <div class="leave-type-buttons">
                        <button type="button" class="leave-type-btn selected" data-type="ì™¸ì¶œ">ì™¸ì¶œ</button>
                        <button type="button" class="leave-type-btn" data-type="ì¡°í‡´">ì¡°í‡´</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>í¬ë§ ì¼ì</label>
                 
                    <input type="date" name="date" value="${localTodayStr}" required>
                </div>
                <div class="form-group">
                    <label>ì‚¬ìœ </label>
                    <textarea name="reason" rows="3" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-btn">ì‹ ì²­ ì œì¶œ</button>
                </div>
            </form>
        </div>
        <div class="section leave-history">
            <h2 class="section-title">ë‚˜ì˜ ì‹ ì²­ ë‚´ì—­</h2>
            ${historyHtml}
        </div>`;
}
    
    
    function renderResources(resources) { if (!resources || resources.length === 0) return '<div class="empty-state">ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; const resourcesHtml = resources.map(res => `<div class="card"><a href="${res.ë§í¬ || '#'}" target="_blank" style="text-decoration: none; color: var(--primary-color); font-weight: 600;">${res.ìë£Œëª… || ''}</a></div>`).join(''); return `<div class="section grid-container">${resourcesHtml}</div>`;}
async function submitLeaveRequest(form) { const type = form.querySelector('.leave-type-btn.selected')?.dataset.type; if (!type) { alert('ì‹ ì²­ ì¢…ë¥˜(ì™¸ì¶œ ë˜ëŠ” ì¡°í‡´)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; } const params = new URLSearchParams({ action: 'submitLeaveRequest', studentId: currentUser.studentId, name: currentUser.name, email: currentUser.email, type: type, date: form.date.value, reason: form.reason.value }); alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘...'); try { const res = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await res.json(); alert(result.message); if (result.status === 'success') loadData(); } catch (error) { alert('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜: ' + error.message); } }
function renderTeacherRoutines(routines) { if (!routines || routines.length === 0) return ''; const routineHtml = routines.map(r => `<label class="routine-item ${completedItems[r.rowNum] ? 'completed' : ''}" onclick="toggleRoutineComplete(this, '${r.rowNum}')"><input type="checkbox" class="routine-checkbox" ${completedItems[r.rowNum] ? 'checked' : ''}><span>${r.ì—…ë¬´ëª…}</span></label>`).join(''); return `<div class="section"><h2 class="section-title">â˜€ï¸ ì˜¤ëŠ˜ì˜ ë£¨í‹´ ì—…ë¬´</h2><div class="routine-tasks-container">${routineHtml}</div></div>`;}
function renderClassManagement(data) { const allPosts = [...(data.allNotices || []), ...(data.allTasks || [])]; return `<div class="section"><h2 class="section-title">ğŸ  í•™ê¸‰ ê´€ë¦¬</h2><div class="accordion-item"><div class="accordion-title">â° ì™¸ì¶œ/ì¡°í‡´ ì‹ ì²­ (${(data.pendingLeaveRequests || []).length}ê±´)</div><div class="accordion-content">${renderLeaveCards(data.pendingLeaveRequests)}</div></div><div class="accordion-item"><div class="accordion-title">ğŸ“ ê³¼ì œë³„ ì œì¶œ í˜„í™© (${(data.assignments || []).length}ê±´)</div><div class="accordion-content">${renderAssignmentCards(data.assignments)}</div></div><div class="accordion-item"><div class="accordion-title">ğŸ“¢ ì•Œë¦¼ í¬í„¸ ê²Œì‹œ í˜„í™© (${allPosts.length}ê±´)</div><div class="accordion-content">${renderPostStatusCards(allPosts)}</div></div><div class="accordion-item"><div class="accordion-title">ğŸ“… ì „ì²´ í•™ê¸‰ ì¼ì • (${(data.classSchedules || []).length}ê±´)</div><div class="accordion-content">${renderScheduleCards(data.classSchedules)}</div></div></div>`;}
function renderLeaveCards(leaves) { if (!leaves || leaves.length === 0) return '<div class="empty-state" style="padding: 20px;">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return leaves.map(req => `<div class="teacher-leave-card card"><div class="leave-header" style="display:flex; justify-content:space-between; align-items:center;"><strong>${req.ì´ë¦„ || ''}(${req.í•™ë²ˆ || ''})</strong><small>${req.ì‹ ì²­ì¢…ë¥˜}(${new Date(req.í¬ë§ì¼ì).toLocaleDateString()})</small></div><textarea class="leave-reason-input">${req.ì‚¬ìœ  || ''}</textarea><div class="leave-actions"><button class="action-btn approve-btn" onclick="updateLeaveStatus(${req.rowNum}, 'ìŠ¹ì¸', this)">ìŠ¹ì¸</button><button class="action-btn reject-btn" onclick="updateLeaveStatus(${req.rowNum}, 'ë°˜ë ¤', this)">ë°˜ë ¤</button></div></div>`).join('');}
function renderAssignmentCards(assignments) {
    if (!assignments || assignments.length === 0) return '<div class="empty-state" style="padding: 20px;">ê´€ë¦¬í•  ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';

    // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: ê²Œì‹œ ì—¬ë¶€ í† ê¸€ ìŠ¤ìœ„ì¹˜ê°€ í¬í•¨ëœ ì¹´ë“œë¡œ ë§Œë“­ë‹ˆë‹¤.
    const assignmentHtml = assignments.map(a => `
        <div class="card post-status-card" style="display:flex; justify-content:space-between; align-items:center;">
            <span>${a.title}</span>
            <label class="toggle-switch">
                <input type="checkbox" onchange="updateSheetItemStatus(this, ${a.rowNum}, 'Assignments')" ${a.ê²Œì‹œì—¬ë¶€ === 'Y' ? 'checked' : ''}>
                <span class="slider"></span>
            </label>
        </div>
    `).join('');
    
    return `<div class="post-list-container">${assignmentHtml}</div>`;
}
    
    
    
    function renderPostStatusCards(posts) { if (!posts || posts.length === 0) return '<div class="empty-state" style="padding: 20px;">ê²Œì‹œëœ ì•Œë¦¼/í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; const postListHtml = posts.sort((a, b) => b.rowNum - a.rowNum).map(item => `<div class="card post-status-card" style="display:flex; justify-content:space-between; align-items:center;" data-title="${(item.ì œëª© || '').toLowerCase()}" data-status="${item.ê²Œì‹œì—¬ë¶€}"><span>${item.ì œëª©}</span><label class="toggle-switch"><input type="checkbox" onchange="updatePostStatus(this, ${item.rowNum})" ${item.ê²Œì‹œì—¬ë¶€ === 'Y' ? 'checked' : ''}><span class="slider"></span></label></div>`).join(''); return `<div class="post-filter-controls"><input type="search" class="post-search-input" placeholder="ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." oninput="applyPostFilters(this.closest('.accordion-content'))"><div class="post-filter-tabs"><button class="post-filter-btn active" data-filter="all" onclick="handleFilterButtonClick(this)">ì „ì²´</button><button class="post-filter-btn" data-filter="Y" onclick="handleFilterButtonClick(this)">ê²Œì‹œì¤‘</button><button class="post-filter-btn" data-filter="N" onclick="handleFilterButtonClick(this)">ìˆ¨ê¹€</button></div></div><div class="post-list-container">${postListHtml}</div><div class="empty-state post-filter-empty" style="display:none; padding: 20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;}
function renderScheduleCards(schedules) {
    if (!schedules || schedules.length === 0) return '<div class="empty-state" style="padding: 20px;">ë“±ë¡ëœ í•™ê¸‰ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

    // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: ê²Œì‹œ ì—¬ë¶€ í† ê¸€ ìŠ¤ìœ„ì¹˜ê°€ í¬í•¨ëœ ì¹´ë“œë¡œ ë§Œë“­ë‹ˆë‹¤.
    const scheduleHtml = schedules.map(s => `
        <div class="card post-status-card" style="display:flex; justify-content:space-between; align-items:center;">
            <span>${s.ì œëª©}</span>
            <label class="toggle-switch">
                <input type="checkbox" onchange="updateSheetItemStatus(this, ${s.rowNum}, 'ClassSchedules')" ${s.ê²Œì‹œì—¬ë¶€ === 'Y' ? 'checked' : ''}>
                <span class="slider"></span>
            </label>
        </div>
    `).join('');

    return `<div class="post-list-container">${scheduleHtml}</div>`;
}
    
    
    
    function renderTeacherPersonalTasks(tasks) { if (!tasks || tasks.length === 0) return ''; let tasksHtml = tasks.map(task => `<div class="card"><div class="card-title">${task.ë‚´ìš©}</div>${task.ë§í¬ ? `<a href="${task.ë§í¬}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">ë°”ë¡œê°€ê¸°</a>` : ''}</div>`).join(''); return `<div class="section"><h2 class="section-title">ğŸ“‹ ì—…ë¬´ ì¼ì§€</h2><div class="grid-container">${tasksHtml}</div></div>`;}
async function updateLeaveStatus(rowNum, status, button) { const reasonInput = button.closest('.teacher-leave-card').querySelector('.leave-reason-input'); const modifiedReason = reasonInput ? reasonInput.value : ''; const params = new URLSearchParams({ action: 'updateLeaveStatus', rowNum, status, modifiedReason }); alert('ì²˜ë¦¬ ì¤‘...'); try { const res = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await res.json(); alert(result.message); if (result.status === 'success') loadData(); } catch (error) { alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + error.message); } }
function toggleRoutineComplete(label, itemId) { const checkbox = label.querySelector('.routine-checkbox'); checkbox.checked = !checkbox.checked; if (checkbox.checked) { completedItems[itemId] = true; label.classList.add('completed'); } else { delete completedItems[itemId]; label.classList.remove('completed'); } saveCompletedItems();}
async function updatePostStatus(checkbox, rowNum) { const newStatus = checkbox.checked ? 'Y' : 'N'; const card = checkbox.closest('.post-status-card'); card.dataset.status = newStatus; card.style.opacity = '0.5'; const params = new URLSearchParams({ action: 'updatePostStatus', rowNum, newStatus }); try { const response = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await response.json(); if (result.status !== 'success') throw new Error(result.message); } catch (error) { alert(`ì˜¤ë¥˜: ${error.message}`); checkbox.checked = !checkbox.checked; card.dataset.status = checkbox.checked ? 'Y' : 'N'; } finally { card.style.opacity = '1'; } }
/**
 * ì§€ì •ëœ ì‹œíŠ¸ì˜ í•­ëª© ê²Œì‹œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë²”ìš© í•¨ìˆ˜
 * @param {HTMLInputElement} checkbox - í´ë¦­ëœ ì²´í¬ë°•ìŠ¤ ìš”ì†Œ
 * @param {number} rowNum - êµ¬ê¸€ ì‹œíŠ¸ì˜ í–‰ ë²ˆí˜¸
 * @param {string} sheetName - ìƒíƒœë¥¼ ë³€ê²½í•  ì‹œíŠ¸ì˜ ì´ë¦„ (ì˜ˆ: 'Assignments', 'ClassSchedules')
 */
async function updateSheetItemStatus(checkbox, rowNum, sheetName) {
    const newStatus = checkbox.checked ? 'Y' : 'N';
    const card = checkbox.closest('.post-status-card');
    card.style.opacity = '0.5'; // ì²˜ë¦¬ ì¤‘ì„ì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ

    const params = new URLSearchParams({
        action: 'updateSheetItemStatus', // ìƒˆë¡œìš´ ì•¡ì…˜ ì´ë¦„
        rowNum,
        sheetName,
        newStatus
    });

    try {
        const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await response.json();
        if (result.status !== 'success') {
            throw new Error(result.message);
        }
    } catch (error) {
        alert(`ì˜¤ë¥˜: ${error.message}`);
        checkbox.checked = !checkbox.checked; // ì‹¤íŒ¨ ì‹œ í† ê¸€ ì›ìœ„ì¹˜
    } finally {
        card.style.opacity = '1'; // ì²˜ë¦¬ ì™„ë£Œ í›„ ì‹œê°ì  íš¨ê³¼ ì œê±°
    }
}
    
    
    async function submitNewPost(form) { const formData = new FormData(form); const params = new URLSearchParams({ action: 'createNewPost', ...Object.fromEntries(formData.entries()) }); const submitButton = form.querySelector('button[type="submit"]'); submitButton.textContent = 'ë“±ë¡ ì¤‘...'; submitButton.disabled = true; try { const response = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await response.json(); if (result.status !== 'success') { throw new Error(result.message); } alert(result.message); document.getElementById('new-post-modal').style.display = 'none'; form.reset(); loadData(); } catch (error) { alert('ì˜¤ë¥˜: ' + error.message); } finally { submitButton.textContent = 'ë“±ë¡í•˜ê¸°'; submitButton.disabled = false; } }
function handleFilterButtonClick(buttonEl) { const container = buttonEl.closest('.post-filter-tabs'); container.querySelectorAll('.post-filter-btn').forEach(btn => btn.classList.remove('active')); buttonEl.classList.add('active'); applyPostFilters(buttonEl.closest('.accordion-content')); }
function applyPostFilters(containerEl) { const searchTerm = (containerEl.querySelector('.post-search-input') || {value: ''}).value.toLowerCase(); const activeFilter = (containerEl.querySelector('.post-filter-btn.active') || {dataset: {filter: 'all'}}).dataset.filter; const allPosts = containerEl.querySelectorAll('.post-status-card'); let visibleCount = 0; allPosts.forEach(post => { const title = post.dataset.title || ''; const status = post.dataset.status || ''; const matchesSearch = title.includes(searchTerm); const matchesFilter = (activeFilter === 'all' || status === activeFilter); if (matchesSearch && matchesFilter) { post.style.display = 'flex'; visibleCount++; } else { post.style.display = 'none'; } }); const emptyState = containerEl.querySelector('.post-filter-empty'); if (emptyState) { emptyState.style.display = visibleCount === 0 ? 'block' : 'none'; } }
</script>
</body>
</html>
