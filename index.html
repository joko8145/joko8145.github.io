<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïä§ÎßàÌä∏ ÌïôÍ∏â Í¥ÄÎ¶¨ ÌîåÎû´Ìèº</title>
    <link rel="icon" type="image/png" href="/portal-dev/favicon.png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* [ÏÉà UI ÎîîÏûêÏù∏ CSS] */
        :root {
            --primary-color: #5D78E6;
            --secondary-color: #A25AF2;
            --light-bg: #f4f6fc;
            --white-bg: #ffffff;
            --text-dark: #212529;
            --text-light: #6c757d;
            --border-color: #e9ecef;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light-bg);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .auth-container {
            padding: 0 30px;
            text-align: right;
            background-color: #343a40;
            min-height: 60px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .date-display { font-size: 1.2em; opacity: 0.9; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            font-size: 1.1em;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        .card {
            background: var(--white-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .card-title { font-size: 1.1em; font-weight: 600; margin-bottom: 8px; color: var(--text-dark); }
        .card-description { font-size: 0.95em; color: var(--text-light); line-height: 1.6; }
        
        /* Ïú†Ï†Ä Ï†ïÎ≥¥ */
        .user-display { display: flex; align-items: center; gap: 12px; }
        .user-profile-image { width: 36px; height: 36px; border-radius: 50%; }
        .user-name-logout { color: white; font-size: 0.9em; text-align: left; }
        .user-name-logout strong { display: block; }
        .user-name-logout a { color: #adb5bd; text-decoration: none; }

        /* ÏúÑÏ†Ø */
        #widgets-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .widget { background-color: var(--white-bg); padding: 20px; text-align: center; border-radius: var(--border-radius); box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
        .widget-title { font-weight: 500; margin-bottom: 8px; color: var(--text-light); }
        .widget-content { font-size: 2.2em; font-weight: 700; color: var(--primary-color); }

        /* ÎØ∏Ï†úÏ∂ú Í≥ºÏ†ú */
        .unsubmitted-section { background-color: #fff9e6; border: 1px solid #ffe7ab; color: #8a6d3b; padding: 15px 20px; margin-bottom: 30px; border-radius: var(--border-radius); }
        .unsubmitted-section p { font-weight: 600; margin-bottom: 8px; }

        /* ÌÉ≠ Î©îÎâ¥ */
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; }
        .tab-button { padding: 12px 18px; cursor: pointer; border: none; background: none; font-size: 1em; font-weight: 500; color: var(--text-light); position: relative; transition: color 0.2s; }
        .tab-button.active { color: var(--primary-color); font-weight: 600; }
        .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background-color: var(--primary-color); border-radius: 3px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Í≥µÏßÄ & Ìï† Ïùº Ïπ¥Îìú */
        .notice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--white-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--primary-color);
        }
        .action-btn { padding: 8px 16px; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500; transition: background-color 0.2s; text-decoration: none; display: inline-block; margin-top: 12px; }
        .complete-btn { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 14px; border-radius: 20px; cursor: pointer; font-size: 0.9em; flex-shrink: 0; margin-left: 15px; }

        /* Ïô∏Ï∂ú/Ï°∞Ìá¥ Ìèº */
        .leave-form { background: #f8f9fa; padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
        .leave-type-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .leave-type-btn { background-color: #e9ecef; color: #495057; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }
        .leave-type-btn.selected { background-color: var(--primary-color); color: white; font-weight: 600; }
        .form-actions { text-align: right; }
        .form-actions .action-btn { background-color: var(--primary-color); }
        .leave-history .card { display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; font-weight: 600; color: white; }
        .status-ÏäπÏù∏ { background-color: #28a745; }
        .status-Î∞òÎ†§ { background-color: #dc3545; }
        .status-Ïã†Ï≤≠ { background-color: #ffc107; }

    </style>
</head>
<body>
    <div class="container">
        <div class="auth-container">
            <div id="user-display" style="display: none;"></div>
            <div id="gsi-container"></div>
        </div>
        <div class="header">
            <h1>üì¢ Ïò§ÎäòÏùò ÏïåÎ¶º</h1>
            <div class="date-display" id="dateDisplay"></div>
        </div>
        <div class="content">
            <!-- ÌïôÏÉù/ÍµêÏÇ¨ Î∑∞Í∞Ä Ïù¥ ÏïàÏóê Î†åÎçîÎßÅÎê©ÎãàÎã§ -->
            <div id="student-portal" style="display: none;"></div>
            <div id="teacher-dashboard" style="display: none;"></div>
        </div>
    </div>

<script>
// [ÏÉà UI Ï†ÅÏö© ÏµúÏ¢Ö Ïä§ÌÅ¨Î¶ΩÌä∏ ÏΩîÎìú]

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgr1HhCTgNnbj1umxlhVPOavO-BCTJOCZN2AZgMtAXiwwCeZFYcsmLOA4-8rR7fCeE/exec';
const GOOGLE_CLIENT_ID = '209932065927-v6kg2bd8gmgfdrksaqrhb7lqo12j6vrf.apps.googleusercontent.com';

let currentUser = null;
let completedItems = {}; // 'ÌôïÏù∏' ÎàÑÎ•∏ Ìï≠Î™©ÏùÑ Ï†ÄÏû•ÌïòÎäî Í∞ùÏ≤¥

window.onload = function() {
    try {
        currentUser = JSON.parse(localStorage.getItem('userInfo'));
    } catch (e) {
        localStorage.removeItem('userInfo');
        currentUser = null;
    }
    loadCompletedItems();
    updateDateDisplay();

    if (currentUser) {
        renderUserInfo(currentUser);
        loadData();
    } else {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleCredentialResponse,
            ux_mode: 'redirect',
            login_uri: 'https://joko8145.github.io/portal-dev'
        });
        google.accounts.id.prompt((notification) => {
            if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                google.accounts.id.renderButton(document.getElementById('gsi-container'), { theme: 'outline', size: 'large' });
            }
        });
    }
    setupEventListeners();
};

function setupEventListeners() {
    document.body.addEventListener('click', function(e) {
        const target = e.target;

        if (target.closest('.tab-button')) {
            const button = target.closest('.tab-button');
            const targetPaneId = button.dataset.tab;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            button.classList.add('active');
            document.getElementById(targetPaneId).classList.add('active');
        }
        
        if (target.closest('.leave-type-btn')) {
            document.querySelectorAll('.leave-type-btn').forEach(btn => btn.classList.remove('selected'));
            target.classList.add('selected');
        }
    });

    document.body.addEventListener('submit', function(e) {
        if (e.target.id === 'leave-request-form') {
            e.preventDefault();
            submitLeaveRequest(e.target);
        }
    });
}

function loadCompletedItems() {
    const todayStr = new Date().toISOString().split('T')[0];
    const storedData = localStorage.getItem('completedItems');
    if (storedData) {
        try {
            const data = JSON.parse(storedData);
            if (data.date === todayStr) { completedItems = data.items || {}; } 
            else { localStorage.removeItem('completedItems'); completedItems = {}; }
        } catch (e) { localStorage.removeItem('completedItems'); completedItems = {}; }
    }
}

function saveCompletedItems() {
    localStorage.setItem('completedItems', JSON.stringify({ date: new Date().toISOString().split('T')[0], items: completedItems }));
}

async function handleCredentialResponse(response) {
    if (response && response.credential) {
        const userObject = JSON.parse(atob(response.credential.split('.')[1]));
        currentUser = { name: userObject.name, email: userObject.email, picture: userObject.picture };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        window.location.reload();
    }
}

function handleLogout() {
    localStorage.clear();
    google.accounts.id.disableAutoSelect();
    location.reload();
}

function updateDateDisplay() {
    document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
}

async function loadData() {
    const targetEl = document.getElementById('student-portal');
    targetEl.style.display = 'block';
    targetEl.innerHTML = '<div class="empty-state">üîÑ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
    
    const fullUrl = `${SCRIPT_URL}?v=${new Date().getTime()}&email=${encodeURIComponent(currentUser.email)}`;
    try {
        const response = await fetch(fullUrl);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        currentUser = { ...currentUser, ...data.user };
        localStorage.setItem('userInfo', JSON.stringify(currentUser));
        renderUserInfo(currentUser);
        
        renderStudentPortal(data); // ÌïôÏÉù Ìè¨ÌÑ∏ UI Î†åÎçîÎßÅ
        
    } catch (error) {
        targetEl.innerHTML = `<div class="empty-state">‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}</div>`;
    }
}
    
function renderUserInfo(user) {
    const displayEl = document.getElementById('user-display');
    document.getElementById('gsi-container').style.display = 'none';
    displayEl.style.display = 'block';
    let userInfoHtml = user.picture ? `<img src="${user.picture}" class="user-profile-image" alt="profile">` : `...`;
    displayEl.innerHTML = `<div class="user-display">${userInfoHtml}<div class="user-name-logout"><strong>${user.name}</strong><a href="#" onclick="handleLogout()">Î°úÍ∑∏ÏïÑÏõÉ</a></div></div>`;
}

function renderStudentPortal(data) {
    const portal = document.getElementById('student-portal');
    portal.innerHTML = `
        ${renderWidgets(data.widgets)}
        ${renderUnsubmitted(data.unsubmitted)}
        ${renderStudentClassSchedules(data.classSchedules)}

        <div class="tabs">
            <button class="tab-button active" data-tab="main-pane">ÏïåÎ¶º & Ìï† Ïùº</button>
            <button class="tab-button" data-tab="leave-pane" style="display:none;">Ïô∏Ï∂ú/Ï°∞Ìá¥</button>
            <button class="tab-button" data-tab="resource-pane" style="display:none;">ÏûêÎ£åÏã§</button>
        </div>

        <div class="tab-content">
            <div id="main-pane" class="tab-pane active">
                ${renderItemsSection('notices', data.notices, 'üìå Ï§ëÏöî Í≥µÏßÄ')}
                ${renderItemsSection('tasks', data.tasks, '‚úÖ Ïò§ÎäòÏùò Ìï† Ïùº')}
            </div>
            <div id="leave-pane" class="tab-pane">
                ${renderLeaveSection(data.leaveRequests)}
            </div>
            <div id="resource-pane" class="tab-pane">
                ${renderResources(data.resources)}
            </div>
        </div>
    `;

    if (data.user?.studentId) portal.querySelector('[data-tab="leave-pane"]').style.display = 'inline-block';
    if (data.resources && data.resources.length > 0) portal.querySelector('[data-tab="resource-pane"]').style.display = 'inline-block';
}

function renderWidgets(widgets) {
    if (!widgets || widgets.length === 0) return '';
    const widgetHtml = widgets.map(widget => {
        let contentHtml = widget.ÎÇ¥Ïö© || '';
        if (widget.ÏúÑÏ†ØÏ¢ÖÎ•ò === 'ÎîîÎç∞Ïù¥') {
            const targetDate = new Date(contentHtml);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            contentHtml = diff === 0 ? "D-Day" : diff > 0 ? `D-${diff}` : `D+${-diff}`;
        }
        return `<div class="widget"><div class="widget-title">${widget.Ï†úÎ™© || ''}</div><div class="widget-content">${contentHtml}</div></div>`;
    }).join('');
    return `<div id="widgets-container">${widgetHtml}</div>`;
}
    
function renderUnsubmitted(tasks) {
    if (!tasks || tasks.length === 0) return '';
    const listHtml = tasks.map(t => `<li>üëå ${t.Ï†úÎ™© || t.ÎÇ¥Ïö© || ''}</li>`).join('');
    return `<div class="unsubmitted-section"><p>üîî ÏïÑÏßÅ ÏôÑÎ£åÌïòÏßÄ ÏïäÏùÄ Ìï† ÏùºÏù¥ ÏûàÏñ¥Ïöî!</p><ul style="list-style: none; padding-left: 0; margin-top: 5px;">${listHtml}</ul></div>`;
}

function renderStudentClassSchedules(schedules) {
    if (!schedules || schedules.length === 0) return '';
    const schedulesHtml = schedules.map(s => `<div class="card"><p>${s.Ï†úÎ™© || ''}</p></div>`).join('');
// ÏàòÏ†ï ÌõÑ ÏΩîÎìú
function renderStudentClassSchedules(schedules) {
    if (!schedules || schedules.length === 0) return '';
    const schedulesHtml = schedules.map(s => `<div class="card"><p>${s.Ï†úÎ™© || ''}</p></div>`).join('');
    return `<div class="section">
                <h2 class="section-title">üóìÔ∏è ÌïôÍ∏â ÏùºÏ†ï</h2>
                <div class="grid-container">${schedulesHtml}</div>
            </div>`;
}

function renderItemsSection(type, items, sectionTitle) {
    const unreadItems = (items || []).filter(item => !completedItems[item.id]);
    if (unreadItems.length === 0) {
        return `<div class="section"><h2 class="section-title">${sectionTitle}</h2><div class="empty-state">Î™®Îëê ÌôïÏù∏ÌñàÏäµÎãàÎã§! üëç</div></div>`;
    }

    const itemsHtml = unreadItems.map(item => {
        const isTask = type === 'tasks';
        const actionButton = isTask
            ? `<a href="${item.ÎßÅÌÅ¨ || '#'}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">Í∏∞Î°ùÌïòÍ∏∞</a>`
            : (item.ÎßÅÌÅ¨ ? `<a href="${item.ÎßÅÌÅ¨}" target="_blank" class="action-btn" style="background-color: var(--primary-color);">Î∞îÎ°úÍ∞ÄÍ∏∞</a>` : '');

        return `<div class="notice-item" id="${item.id}">
                    <div style="flex-grow: 1;">
                        <div class="card-title">${item.ÏïÑÏù¥ÏΩò || ''} ${item.Ï†úÎ™© || ''}</div>
                        <p class="card-description">${item.ÎÇ¥Ïö© || ''}</p>
                        ${actionButton}
                    </div>
                    <button class="complete-btn" onclick="completeItem('${item.id}')">ÌôïÏù∏</button>
                </div>`;
    }).join('');

    return `<div class="section"><h2 class="section-title">${sectionTitle}</h2>${itemsHtml}</div>`;
}

function completeItem(itemId) {
    completedItems[itemId] = true;
    saveCompletedItems();
    const itemElement = document.getElementById(itemId);
    if (itemElement) {
        itemElement.style.transition = 'opacity 0.3s, transform 0.3s';
        itemElement.style.opacity = '0';
        itemElement.style.transform = 'translateY(-10px)';
        setTimeout(() => { itemElement.remove(); }, 300);
    }
}

function renderLeaveSection(requests) {
    const historyHtml = (!requests || requests.length === 0) ? '<div class="empty-state">Ïã†Ï≤≠ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>' : requests.map(req => {
        const requestDate = req.Ìù¨ÎßùÏùºÏûê ? new Date(req.Ìù¨ÎßùÏùºÏûê).toLocaleDateString() : 'ÎÇ†Ïßú ÏóÜÏùå';
        const certButton = (req.ÏÉÅÌÉú === 'ÏäπÏù∏' && req.Ïã†Ï≤≠ÌñâÎ≤àÌò∏) ? `<a href="${SCRIPT_URL}?action=getCertificate&rowNum=${req.Ïã†Ï≤≠ÌñâÎ≤àÌò∏}" target="_blank" class="action-btn" style="background-color:#17a2b8; padding: 5px 10px; font-size: 0.8em; margin: 0;">ÌôïÏù∏Ï¶ù</a>` : '';
        return `<div class="card">
                    <div>
                        <strong>${req.Ïã†Ï≤≠Ï¢ÖÎ•ò}</strong> (${requestDate})<br>
                        <small>ÏÇ¨Ïú†: ${req.ÏÇ¨Ïú† || ''}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="status-badge status-${req.ÏÉÅÌÉú}">${req.ÏÉÅÌÉú}</span>
                        ${certButton}
                    </div>
                </div>`;
    }).join('');
    
    return `<div class="leave-form">
                <h2 class="section-title" style="border: none; margin-bottom: 20px;">Ïô∏Ï∂ú/Ï°∞Ìá¥ Ïã†Ï≤≠ÌïòÍ∏∞</h2>
                <form id="leave-request-form">
                    <div class="form-group">
                        <label>Ïã†Ï≤≠ Ï¢ÖÎ•ò</label>
                        <div class="leave-type-buttons">
                            <button type="button" class="leave-type-btn selected" data-type="Ïô∏Ï∂ú">Ïô∏Ï∂ú</button>
                            <button type="button" class="leave-type-btn" data-type="Ï°∞Ìá¥">Ï°∞Ìá¥</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ìù¨Îßù ÏùºÏûê</label>
                        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>ÏÇ¨Ïú†</label>
                        <textarea name="reason" rows="3" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="action-btn">Ïã†Ï≤≠ Ï†úÏ∂ú</button>
                    </div>
                </form>
            </div>
            <div class="section leave-history">
                <h2 class="section-title">ÎÇòÏùò Ïã†Ï≤≠ ÎÇ¥Ïó≠</h2>
                ${historyHtml}
            </div>`;
}

function renderResources(resources) {
    if (!resources || resources.length === 0) return '<div class="empty-state">Îì±Î°ùÎêú ÏûêÎ£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    const resourcesHtml = resources.map(res => `<div class="card"><a href="${res.ÎßÅÌÅ¨ || '#'}" target="_blank" style="text-decoration: none; color: var(--primary-color); font-weight: 600;">${res.ÏûêÎ£åÎ™Ö || ''}</a></div>`).join('');
// ÏàòÏ†ï ÌõÑ ÏΩîÎìú
function renderResources(resources) {
    if (!resources || resources.length === 0) return '<div class="empty-state">Îì±Î°ùÎêú ÏûêÎ£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
    const resourcesHtml = resources.map(res => `<div class="card"><a href="${res.ÎßÅÌÅ¨ || '#'}" target="_blank" style="text-decoration: none; color: var(--primary-color); font-weight: 600;">${res.ÏûêÎ£åÎ™Ö || ''}</a></div>`).join('');
    return `<div class="section grid-container">${resourcesHtml}</div>`;
}

async function submitLeaveRequest(form) {
    const type = form.querySelector('.leave-type-btn.selected')?.dataset.type;
    if (!type) {
        alert('Ïã†Ï≤≠ Ï¢ÖÎ•ò(Ïô∏Ï∂ú ÎòêÎäî Ï°∞Ìá¥)Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
        return;
    }
    
    const params = new URLSearchParams({ 
        action: 'submitLeaveRequest', 
        studentId: currentUser.studentId, 
        name: currentUser.name, 
        email: currentUser.email,
        type: type,
        date: form.date.value,
        reason: form.reason.value
    });
    
    alert('Ïã†Ï≤≠ Ï≤òÎ¶¨ Ï§ë...');
    try {
        const res = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await res.json();
        alert(result.message);
        if (result.status === 'success') loadData();
    } catch (error) { alert('Ïã†Ï≤≠ Ï§ë Ïò§Î•ò: ' + error.message); }
}

</script>
</body>
</html>
